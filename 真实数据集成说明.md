# 真实数据集成说明

## 📊 概述

本次更新将大屏所有统计数据改为调用真实接口，支持时间范围切换（今日、本周、本月、本年），修复了人脸热力图只显示进场未显示出场的问题。

## 🎯 实现内容

### 1. 统计数据实时化

#### 1.1 车辆统计
- **数据源**: `report_car_in` 和 `report_car_out` 表
- **统计字段**: `create_time`（创建时间）
- **统计指标**:
  - 今日进场：统计进场记录数
  - 今日出场：统计出场记录数
  - 今日在场：进场数 - 出场数

#### 1.2 人脸统计
- **数据源**: `acms_event_record` 表
- **统计字段**: `event_time`（事件时间）
- **区分方向**: `direction` 字段（'进' / '出'）
- **统计指标**:
  - 今日人脸进场：direction = '进' 的记录数
  - 今日人脸出场：direction = '出' 的记录数

#### 1.3 违规统计
- **数据源**: 远程接口 `https://localhost:8543/parking/violations`
- **查询参数**:
  - `community`: 东北林业大学
  - `startDate`: 开始时间
  - `endDate`: 结束时间
- **统计指标**: 返回的 total 字段

### 2. 时间范围切换

#### 2.1 支持的时间范围
- **今日**: 当天 00:00:00 - 23:59:59
- **本周**: 本周一 00:00:00 - 今天 23:59:59
- **本月**: 本月1号 00:00:00 - 今天 23:59:59
- **本年**: 今年1月1号 00:00:00 - 今天 23:59:59

#### 2.2 实时切换
- 点击顶部时间选择按钮（今日、本周、本月、本年）
- 自动重新加载统计数据
- 更新人脸热力图数据

### 3. 人脸热力图进出区分

#### 3.1 修复内容
- 原来只统计总数，不区分进出方向
- 现在按照 `direction` 字段分别统计进场和出场

#### 3.2 返回数据
- `heatmapData`: 总计数据（进+出）
- `entryHeatmapData`: 进场数据
- `exitHeatmapData`: 出场数据
- `locations`: 位置列表（通道名称）

## 🔧 后端接口

### 新增统计接口

#### 1. 车辆进场统计
```
GET http://localhost:8675/parking/statistics/vehicle-entry
参数: startDate, endDate
返回: Integer（进场车辆数）
```

#### 2. 车辆出场统计
```
GET http://localhost:8675/parking/statistics/vehicle-exit
参数: startDate, endDate
返回: Integer（出场车辆数）
```

#### 3. 人脸进场统计
```
GET http://localhost:8675/parking/statistics/face-entry
参数: startDate, endDate
返回: Integer（进场人次）
```

#### 4. 人脸出场统计
```
GET http://localhost:8675/parking/statistics/face-exit
参数: startDate, endDate
返回: Integer（出场人次）
```

### 修改的接口

#### 人脸热力图
```
GET http://localhost:8675/parking/face-monitor/heatmap
参数: timeRange (today/week/month/year)
返回: {
  heatmapData: [[hour, locationIndex, count], ...],
  entryHeatmapData: [[hour, locationIndex, count], ...],
  exitHeatmapData: [[hour, locationIndex, count], ...],
  locations: ['1号门', '2号门', ...]
}
```

## 📁 文件修改清单

### 后端文件

#### 新建
- `StatisticsController.java` - 统计数据控制器
  - 车辆进出统计
  - 人脸进出统计

#### 修改
- `FaceMonitorController.java` - 人脸监控控制器
  - 增加进出方向区分
  - 返回分类数据

### 前端文件

#### 修改
- `center.vue` - 中心监控页面
  - 添加 `loadStatisticsData()` 方法
  - 添加 `getDateRange()` 时间范围计算
  - 添加车辆/人脸统计方法
  - 添加违规统计方法
  - 添加时间范围切换监听
  - 更新热力图数据接收逻辑

## 🚀 使用说明

### 1. 启动后端服务
```bash
cd d:\nefu-edu-datav\boot-new-20251112
# 确保数据库连接正确
# 启动 Spring Boot 应用
```

### 2. 启动前端服务
```bash
cd d:\nefu-edu-datav\vue-big-screen-master
npm run serve
```

### 3. 访问大屏
```
http://localhost:8080
```

### 4. 查看数据
- 页面加载后自动显示今日数据
- 点击顶部时间按钮切换统计范围
- 人脸热力图会根据选择的时间范围更新

## 📊 数据流程

```
用户选择时间范围
    ↓
前端计算开始/结束时间
    ↓
并行调用5个统计接口
    ├─ 车辆进场统计 (report_car_in)
    ├─ 车辆出场统计 (report_car_out)
    ├─ 人脸进场统计 (acms_event_record, direction='进')
    ├─ 人脸出场统计 (acms_event_record, direction='出')
    └─ 违规统计 (远程API)
    ↓
计算在场数 (进场-出场)
    ↓
更新页面显示
    ↓
更新人脸热力图
```

## ⚠️ 注意事项

### 1. 数据库配置
确保以下表存在且有数据：
- `report_car_in` - 车辆进场记录
- `report_car_out` - 车辆出场记录
- `acms_event_record` - 人脸识别记录

### 2. 字段要求
- `report_car_in.create_time` - 进场创建时间
- `report_car_out.create_time` - 出场创建时间
- `acms_event_record.event_time` - 事件时间
- `acms_event_record.direction` - 方向（'进'/'出'）

### 3. 远程接口
违规统计接口需要：
- URL: `https://localhost:8543`
- 端口: 8543
- 参数: community = "东北林业大学"

### 4. 跨域配置
`StatisticsController` 已添加 `@CrossOrigin` 注解支持跨域请求

## 🔍 调试方法

### 查看控制台日志
浏览器F12 -> Console，查看：
- `[统计数据] 开始加载...` - 统计开始
- `[时间范围]` - 查询的时间范围
- `[车辆进场] 统计失败` - 接口错误
- `[统计数据] 加载完成` - 统计结果

### 查看后端日志
Spring Boot 控制台，查看：
- `📊 [车辆进场统计] 开始查询`
- `✅ [车辆进场统计] 查询完成: X 辆`
- `❌ [统计] 查询失败` - 数据库错误

### 网络请求检查
浏览器F12 -> Network，检查：
- `/parking/statistics/vehicle-entry` - 进场统计
- `/parking/statistics/vehicle-exit` - 出场统计
- `/parking/statistics/face-entry` - 人脸进场
- `/parking/statistics/face-exit` - 人脸出场
- `/parking/violations` - 违规统计

## ✨ 功能特性

✅ 全量真实数据统计
✅ 支持4种时间范围切换
✅ 人脸热力图进出区分
✅ 并行接口调用，性能优化
✅ 完善的错误处理
✅ 详细的日志输出
✅ 跨域支持

## 📝 后续优化建议

1. **缓存优化**: 可以对统计结果进行短时间缓存
2. **性能优化**: 对大数据量查询添加索引
3. **图表优化**: 根据实际数据优化图表展示效果
4. **实时刷新**: 可添加定时自动刷新功能
5. **导出功能**: 添加统计数据导出功能

---

**更新时间**: 2025-11-18  
**版本**: v1.0.0
