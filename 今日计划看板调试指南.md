# 今日计划看板调试指南

## 已修复的问题

### ✅ 问题1：toFixed错误
```
TypeError: Cannot read properties of undefined (reading 'toFixed')
```

**原因**：初始化时 `visitorProgress` 为 `undefined`

**解决**：添加默认值处理 `(this.visitorProgress || 0).toFixed(2)`

## 待诊断的问题

### ⏳ 问题2：车辆和访客显示相同数据

**现象**：点击车辆和访客都显示相同的数据

**可能原因**：
1. 后端API没有正确过滤数据
2. 前端参数传递错误
3. 数据缓存问题

## 调试步骤

### 步骤1：刷新页面

按 `Ctrl + F5` 强制刷新浏览器。

### 步骤2：点击访客水波图

打开控制台（F12），点击左侧"计划访客"水波图。

**查看日志**：
```
📋 [今日计划看板] 加载详细列表，类型: visitor
📋 [今日计划看板] 请求URL: http://localhost:8675/parking/visitor/plan-dashboard/detail-list?type=visitor
📡 [今日计划看板] 详情列表API响应: {...}
✅ [今日计划看板] 检测到嵌套结构，type: visitor
✅ [今日计划看板] 加载到 326 条记录，类型: visitor
📋 [今日计划看板] 前3条数据示例: [...]
```

**检查要点**：
- URL中的type参数是否为 `visitor`
- 响应中的type是否为 `visitor`
- 记录数是否为326（访客总数）

### 步骤3：关闭弹窗，点击车辆水波图

点击右侧"预计车辆"水波图。

**查看日志**：
```
📋 [今日计划看板] 加载详细列表，类型: vehicle
📋 [今日计划看板] 请求URL: http://localhost:8675/parking/visitor/plan-dashboard/detail-list?type=vehicle
📡 [今日计划看板] 详情列表API响应: {...}
✅ [今日计划看板] 检测到嵌套结构，type: vehicle
✅ [今日计划看板] 加载到 306 条记录，类型: vehicle  ← 应该是306，不是326！
📋 [今日计划看板] 前3条数据示例: [...]
```

**检查要点**：
- URL中的type参数是否为 `vehicle`
- 响应中的type是否为 `vehicle`
- 记录数是否为306（车辆总数）
- **前3条数据是否有carNumber字段**

### 步骤4：对比数据示例

**访客数据示例（应该是）**：
```javascript
[
  {
    id: 1,
    visitorName: "张三",
    carNumber: null,  // ← 可能没有车牌号
    ...
  },
  {
    id: 2,
    visitorName: "李四",
    carNumber: "京A12345",  // ← 也可能有车牌号
    ...
  }
]
```

**车辆数据示例（应该是）**：
```javascript
[
  {
    id: 1,
    visitorName: "张三",
    carNumber: "京A12345",  // ← 必须有车牌号
    ...
  },
  {
    id: 2,
    visitorName: "王五",
    carNumber: "京B67890",  // ← 必须有车牌号
    ...
  }
]
```

**关键差异**：车辆列表的所有记录都应该有 `carNumber` 字段且不为空。

## 可能的问题场景

### 场景1：后端过滤失败

**症状**：
- 访客和车辆都返回326条记录
- 数据完全一样

**验证**：查看后端日志
```java
log.info("📋 [今日计划看板] 查询详细列表，类型: {}", type);
```

**解决**：检查后端 `VisitorPlanDashboardController.java` 的 `getDetailList` 方法。

### 场景2：前端参数丢失

**症状**：
- 请求URL中没有type参数
- 或type参数总是 `visitor`

**验证**：查看控制台日志中的URL
```
📋 [今日计划看板] 请求URL: http://localhost:8675/parking/visitor/plan-dashboard/detail-list?type=vehicle
```

**解决**：检查前端点击事件是否正确传递参数。

### 场景3：数据缓存问题

**症状**：
- 第一次点击正确，第二次点击显示缓存的数据

**验证**：
1. 点击访客 → 关闭
2. 点击车辆 → 应该显示不同的数据

**解决**：在 `showDetailModal` 开始时清空列表。

## 后端检查

### 检查后端Controller

打开 `VisitorPlanDashboardController.java`，找到 `getDetailList` 方法：

```java
@GetMapping("/detail-list")
public Result<?> getDetailList(@RequestParam(defaultValue = "visitor") String type) {
    try {
        log.info("📋 [今日计划看板] 查询详细列表，类型: {}", type);
        
        // ... 查询逻辑
        
        // 根据类型过滤
        if ("vehicle".equals(type)) {
            // 车辆：只返回有车牌号的记录
            reservations = reservations.stream()
                .filter(r -> StringUtils.hasText(r.getCarNumber()))
                .collect(Collectors.toList());
        }
        
        log.info("✅ [今日计划看板] 返回 {} 条记录", detailList.size());
    }
}
```

**检查要点**：
- 是否接收到 `type` 参数
- `"vehicle".equals(type)` 条件是否生效
- 过滤后的数量是否正确

### 查看后端日志

重启后端服务后，查看控制台输出：

```
📋 [今日计划看板] 查询详细列表，类型: visitor
✅ [今日计划看板] 返回 326 条记录

📋 [今日计划看板] 查询详细列表，类型: vehicle
✅ [今日计划看板] 返回 306 条记录  ← 应该是不同的数量
```

## 数据库验证

### 查询访客总数
```sql
SELECT COUNT(*) as total
FROM visitor_reservation_sync
WHERE start_time <= NOW()
  AND end_time >= NOW()
  AND deleted = 0;
```

**期望结果**：326

### 查询车辆总数
```sql
SELECT COUNT(*) as total
FROM visitor_reservation_sync
WHERE start_time <= NOW()
  AND end_time >= NOW()
  AND car_number IS NOT NULL
  AND car_number != ''
  AND deleted = 0;
```

**期望结果**：306

### 查询车辆示例数据
```sql
SELECT id, visitor_name, car_number
FROM visitor_reservation_sync
WHERE start_time <= NOW()
  AND end_time >= NOW()
  AND car_number IS NOT NULL
  AND car_number != ''
  AND deleted = 0
LIMIT 5;
```

**期望结果**：所有记录都有 `car_number`

## 快速修复方案

如果后端过滤有问题，临时在前端过滤：

```javascript
async showDetailModal(type) {
  // ... 获取数据
  
  // 前端临时过滤（不推荐，应该在后端过滤）
  if (type === 'vehicle') {
    this.detailList = this.detailList.filter(item => 
      item.carNumber && item.carNumber.trim() !== ''
    );
    console.log('🚗 [前端过滤] 车辆记录:', this.detailList.length);
  }
}
```

## 总结

### ✅ 已修复
- toFixed错误

### 🔍 待验证
- 车辆和访客数据是否不同

### 📋 下一步
1. 刷新页面
2. 查看控制台日志
3. 对比访客和车辆的数据
4. 如有问题，提供控制台日志截图

---

**创建时间**：2025-01-17  
**状态**：待测试
