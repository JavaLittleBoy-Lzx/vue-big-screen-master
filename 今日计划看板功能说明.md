# 今日计划看板功能说明

## 功能概述

今日计划看板用于展示访客预约的实时统计数据，包括计划访客人数、已来访人数、预计车辆数等信息，并支持点击查看详细的预约列表。

## 功能特性

### 1. 数据统计 📊

#### 计划访客
- **定义**：当前时间在预约记录的 `开始时间` 和 `结束时间` 之间的访客人数
- **计算逻辑**：`WHERE start_time <= NOW() AND end_time >= NOW()`
- **显示内容**：
  - 总人数：计划访客总数
  - 水波图填充：已来访人数占比

#### 已来访（水波图占满部分）
- **定义**：`personVisitStatus` 字段包含 "已进场" 或 "来访中" 的记录数
- **作用**：显示访客实际到访情况

#### 预计车辆
- **定义**：当前时间在预约时间范围内 **且** 有车牌号码（`carNumber`不为空）的记录数
- **计算逻辑**：
  ```sql
  WHERE start_time <= NOW() 
    AND end_time >= NOW() 
    AND car_number IS NOT NULL 
    AND car_number != ''
  ```

#### 已到车辆（水波图占满部分）
- **定义**：`carVisitStatus` 字段包含 "已进场" 的记录数
- **作用**：显示车辆实际到达情况

### 2. 点击展示详情 📋

#### 访客详情表格
**触发方式**：点击左侧"计划访客"水波图

**显示列**：
| 列名 | 说明 | 字段 |
|------|------|------|
| 序号 | 自动编号 | - |
| 访客姓名 | 访客的姓名 | `visitorName` |
| 手机号 | 访客联系电话 | `visitorPhone` |
| 被访人 | 预约访问的对象 | `passName` |
| 被访部门 | 被访问的部门 | `passDep` |
| 开始时间 | 预约开始时间 | `startTime` |
| 结束时间 | 预约结束时间 | `endTime` |
| 来访状态 | 人员来访状态 | `personVisitStatus` |

**状态标签样式**：
- 🟢 **已进场/来访中**：绿色标签
- 🟡 **未来访**：橙色标签
- ⚪ **已离场**：灰色标签

#### 车辆详情表格
**触发方式**：点击右侧"预计车辆"水波图

**显示列**：
| 列名 | 说明 | 字段 |
|------|------|------|
| 序号 | 自动编号 | - |
| 访客姓名 | 访客的姓名 | `visitorName` |
| 手机号 | 访客联系电话 | `visitorPhone` |
| **车牌号** | 访客车辆车牌号 | `carNumber` |
| 被访人 | 预约访问的对象 | `passName` |
| 被访部门 | 被访问的部门 | `passDep` |
| 开始时间 | 预约开始时间 | `startTime` |
| 结束时间 | 预约结束时间 | `endTime` |
| 来访状态 | 人员来访状态 | `personVisitStatus` |

**区别**：车辆表格比访客表格多了"车牌号"列

## 后端API

### 1. 获取统计数据

**接口**: `GET /parking/visitor/plan-dashboard/statistics`

**请求参数**: 无

**响应示例**:
```json
{
  "code": "0",
  "msg": "成功",
  "data": {
    "visitorStats": {
      "total": 45,          // 计划访客总数
      "completed": 32,      // 已来访人数
      "pending": 13,        // 待来访人数
      "percentage": "71.1"  // 来访率
    },
    "vehicleStats": {
      "expected": 28,   // 预计车辆数
      "arrived": 20,    // 已到车辆数
      "current": 8      // 待到车辆数
    },
    "dataSource": "DATABASE",
    "updateTime": "2025-01-17T17:30:00"
  }
}
```

### 2. 获取详细列表

**接口**: `GET /parking/visitor/plan-dashboard/detail-list`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | String | 否 | visitor-访客列表<br>vehicle-车辆列表<br>默认: visitor |

**响应示例**:
```json
{
  "code": "0",
  "msg": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "reservationId": "RES20250117001",
        "visitorName": "张三",
        "visitorPhone": "13800138000",
        "visitorIdCard": "110101199001011234",
        "carNumber": "京A12345",
        "startTime": "2025-01-17T08:00:00",
        "endTime": "2025-01-17T18:00:00",
        "passName": "李四",
        "passDep": "技术部",
        "personVisitStatus": "人已进场",
        "carVisitStatus": "已进场",
        "vipTypeName": "临时访客",
        "applyStateName": "已审核"
      }
    ],
    "total": 1,
    "type": "visitor"
  }
}
```

## 前端实现

### 组件文件
`src/views/VisitorPlanDashboard.vue`

### 核心功能

#### 1. 数据加载
```javascript
async loadStatistics() {
  // 调用后端API获取统计数据
  const response = await axios.get('http://localhost:8675/parking/visitor/plan-dashboard/statistics');
  
  // 更新访客统计
  this.visitorStats = data.visitorStats;
  
  // 更新车辆统计
  this.vehicleStats = data.vehicleStats;
  
  // 刷新水波图
  this.updateCharts();
}
```

#### 2. 自动刷新
- **刷新间隔**：30秒
- **实现方式**：`setInterval`定时调用 `loadStatistics()`

#### 3. 点击展示详情
```javascript
async showDetailModal(type) {
  // type: 'visitor' 或 'vehicle'
  this.modalType = type;
  this.showModal = true;
  
  // 调用API获取详细列表
  const response = await axios.get('.../detail-list', {
    params: { type }
  });
  
  this.detailList = response.data.data.list;
}
```

#### 4. 水波图配置
- **库**：`@antv/g2plot` 的 `Liquid` 组件
- **形状**：圆形（circle）
- **动画**：3层波浪效果
- **配色**：
  - 访客：绿色系 `#00ff88`
  - 车辆：蓝色系 `#002ae7`

## 数据库表结构

### 表名：`visitor_reservation_sync`

**关键字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键ID |
| reservation_id | VARCHAR | 预约记录ID（外部系统） |
| visitor_name | VARCHAR | 访客姓名 |
| visitor_phone | VARCHAR | 访客手机号 |
| visitor_id_card | VARCHAR | 访客身份证号 |
| **car_number** | VARCHAR | 随行车辆车牌号 |
| **start_time** | DATETIME | 预约开始时间 |
| **end_time** | DATETIME | 预约结束时间 |
| pass_name | VARCHAR | 被访人 |
| pass_dep | VARCHAR | 被访部门 |
| **person_visit_status** | VARCHAR | 人员来访状态 |
| **car_visit_status** | VARCHAR | 车辆来访状态 |
| vip_type_name | VARCHAR | 预约VIP类型 |
| apply_state_name | VARCHAR | 申请状态名称 |
| deleted | TINYINT | 逻辑删除标记 |

**状态值示例**：
- `person_visit_status`: "人未来访"、"人已进场"、"来访中"、"人已离场"
- `car_visit_status`: "车未来访"、"已进场"、"已离场"

## 使用场景

### 场景1：保安门岗使用
保安可以通过大屏实时查看：
- 今天预约了多少访客
- 已经到达了多少
- 预计有多少辆车要进来
- 已经进场了多少辆车

### 场景2：管理员监控
管理员可以：
- 查看访客到访率
- 点击查看具体的预约信息
- 了解哪些访客还没到
- 监控车辆进出情况

### 场景3：数据统计
系统可以：
- 每30秒自动更新数据
- 实时反映访客到访情况
- 提供准确的在场访客数据

## 测试步骤

### 步骤1：准备测试数据

在数据库中插入测试预约记录：

```sql
-- 插入今天的测试预约（在当前时间范围内）
INSERT INTO visitor_reservation_sync (
  reservation_id, visitor_name, visitor_phone, car_number,
  start_time, end_time, pass_name, pass_dep,
  person_visit_status, car_visit_status,
  vip_type_name, apply_state_name, deleted
) VALUES
-- 已来访的访客（有车）
('TEST001', '张三', '13800138001', '京A12345',
 DATE_ADD(NOW(), INTERVAL -2 HOUR), DATE_ADD(NOW(), INTERVAL 2 HOUR),
 '李四', '技术部', '人已进场', '已进场', '临时访客', '已审核', 0),

-- 已来访的访客（无车）
('TEST002', '李五', '13800138002', NULL,
 DATE_ADD(NOW(), INTERVAL -1 HOUR), DATE_ADD(NOW(), INTERVAL 3 HOUR),
 '王六', '行政部', '来访中', NULL, '临时访客', '已审核', 0),

-- 未来访的访客（有车）
('TEST003', '赵七', '13800138003', '京B67890',
 NOW(), DATE_ADD(NOW(), INTERVAL 4 HOUR),
 '孙八', '市场部', '人未来访', '车未来访', '临时访客', '已审核', 0),

-- 未来访的访客（无车）
('TEST004', '周九', '13800138004', NULL,
 NOW(), DATE_ADD(NOW(), INTERVAL 5 HOUR),
 '吴十', '财务部', '人未来访', NULL, '临时访客', '已审核', 0);
```

### 步骤2：启动后端服务

```bash
cd d:\nefu-edu-datav\boot-new-20251112
mvn spring-boot:run
```

### 步骤3：刷新前端页面

访问大屏页面并刷新（Ctrl + F5）

### 步骤4：验证统计数据

**期望结果**（基于上面的测试数据）：
- **计划访客**：4人（全部4条记录在当前时间范围内）
- **已来访**：2人（水波图填充50%）
- **预计车辆**：2辆（有车牌号的记录）
- **已到车辆**：1辆（水波图填充50%）

### 步骤5：测试详情弹窗

#### 测试访客详情
1. 点击左侧"计划访客"水波图
2. 应该弹出表格，显示4条预约记录
3. 验证状态标签：
   - 张三、李五：绿色标签（已进场/来访中）
   - 赵七、周九：橙色标签（未来访）

#### 测试车辆详情
1. 点击右侧"预计车辆"水波图
2. 应该弹出表格，显示2条有车牌号的记录
3. 验证车牌号列显示正确

### 步骤6：测试自动刷新

1. 保持页面打开
2. 在数据库中更新测试数据：
   ```sql
   UPDATE visitor_reservation_sync
   SET person_visit_status = '人已进场'
   WHERE reservation_id = 'TEST003';
   ```
3. 等待30秒
4. 观察水波图自动更新

## 控制台日志

**成功加载时的日志**：
```
📊 [今日计划看板] 开始加载统计数据...
📡 [今日计划看板] API响应: {code: "0", ...}
✅ [今日计划看板] 数据加载成功 {访客: "2/4", 车辆: "1/2"}
```

**点击详情时的日志**：
```
📋 [今日计划看板] 加载详细列表，类型: visitor
✅ [今日计划看板] 加载到 4 条记录
```

## 故障排查

### 问题1：水波图不显示或显示为0

**可能原因**：
- 数据库中没有符合条件的预约记录
- 预约时间不在当前时间范围内

**解决方案**：
```sql
-- 检查是否有在时间范围内的预约
SELECT COUNT(*) FROM visitor_reservation_sync
WHERE start_time <= NOW()
  AND end_time >= NOW()
  AND deleted = 0;
```

### 问题2：点击水波图没有反应

**可能原因**：
- 后端服务未启动
- API接口地址错误

**解决方案**：
1. 检查后端服务是否运行在8675端口
2. 查看浏览器控制台的网络请求
3. 验证API地址是否正确

### 问题3：状态标签颜色不正确

**可能原因**：
- 数据库中的状态值格式不标准

**解决方案**：
```sql
-- 检查状态值
SELECT DISTINCT person_visit_status FROM visitor_reservation_sync;
SELECT DISTINCT car_visit_status FROM visitor_reservation_sync;

-- 确保状态值包含关键词：已进场、来访中、已离场
```

## 扩展功能建议

1. **数据导出**：添加导出按钮，导出预约列表为Excel
2. **实时推送**：集成WebSocket，实时推送访客到访通知
3. **历史趋势**：添加访客到访率的折线图
4. **访客搜索**：在详情表格中添加搜索功能
5. **统计报表**：按天/周/月统计访客数据

## 总结

### ✅ 已实现功能

1. **实时统计**
   - 计划访客人数统计
   - 已来访人数统计
   - 预计车辆数统计
   - 已到车辆数统计

2. **可视化展示**
   - 水波图动态显示占比
   - 自动刷新（30秒间隔）
   - 渐变发光数字效果

3. **详情查看**
   - 点击水波图展示详情表格
   - 访客/车辆分类展示
   - 状态标签颜色区分
   - 表格滚动支持

4. **用户体验**
   - 响应式设计
   - 平滑动画效果
   - 清晰的视觉层次

---

**文档创建时间**：2025-01-17  
**功能状态**：✅ 已完成  
**测试状态**：⏳ 待验证
