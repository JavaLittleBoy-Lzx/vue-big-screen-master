# 敏感数据脱敏功能说明

## 更新时间
2025-11-25

## 功能概述
在人脸监控详情中添加了手机号和身份证号的显示，并对敏感信息进行了脱敏处理，保护用户隐私。

## 一、脱敏规则

### 1. 手机号脱敏
**规则**：保留前3位和后4位，中间用`****`替代

**示例**：
- 原始号码：`13812345678`
- 脱敏后：`138****5678`

**处理逻辑**：
- 标准11位手机号：显示前3位 + `****` + 后4位
- 其他长度号码：显示前3位 + `****` + 后4位
- 少于7位：直接显示（无法脱敏）
- 空值：显示为空字符串

### 2. 身份证号脱敏
**规则**：保留前6位和后4位，中间用`********`替代

**示例**：
- 18位身份证：`110101********1234`（原始：`110101199001011234`）
- 15位身份证：`110101******123`（原始：`110101900101123`）

**处理逻辑**：
- 18位身份证号：显示前6位 + `********` + 后4位
- 15位身份证号：显示前6位 + `******` + 后3位
- 其他长度：显示前6位 + `********` + 后4位
- 少于10位：直接显示（无法脱敏）
- 空值：显示为空字符串

## 二、后端实现

### 文件位置
`d:\nefu-edu-datav\boot-new-20251112\src\main\java\com\parkingmanage\controller\FaceMonitorController.java`

### 脱敏方法

#### 1. 手机号脱敏方法
```java
/**
 * 手机号脱敏
 * 保留前3位和后4位，中间用****替代
 * 例如：138****5678
 * 
 * @param phoneNo 手机号
 * @return 脱敏后的手机号
 */
private String maskPhoneNumber(String phoneNo) {
    if (phoneNo == null || phoneNo.isEmpty()) {
        return "";
    }
    
    // 如果长度小于7位，无法脱敏，直接返回
    if (phoneNo.length() < 7) {
        return phoneNo;
    }
    
    // 标准11位手机号：保留前3位和后4位
    if (phoneNo.length() == 11) {
        return phoneNo.substring(0, 3) + "****" + phoneNo.substring(7);
    }
    
    // 其他长度：保留前3位和后4位
    return phoneNo.substring(0, 3) + "****" + phoneNo.substring(phoneNo.length() - 4);
}
```

#### 2. 身份证号脱敏方法
```java
/**
 * 身份证号脱敏
 * 保留前6位和后4位，中间用********替代
 * 例如：110101********1234
 * 
 * @param idCard 身份证号
 * @return 脱敏后的身份证号
 */
private String maskIdCard(String idCard) {
    if (idCard == null || idCard.isEmpty()) {
        return "";
    }
    
    // 如果长度小于10位，无法脱敏，直接返回
    if (idCard.length() < 10) {
        return idCard;
    }
    
    // 标准18位身份证号：保留前6位和后4位
    if (idCard.length() == 18) {
        return idCard.substring(0, 6) + "********" + idCard.substring(14);
    }
    
    // 15位旧身份证号：保留前6位和后3位
    if (idCard.length() == 15) {
        return idCard.substring(0, 6) + "******" + idCard.substring(12);
    }
    
    // 其他长度：保留前6位和后4位
    return idCard.substring(0, 6) + "********" + idCard.substring(idCard.length() - 4);
}
```

### 调用位置
在 `/list` 接口的数据返回处理中：

```java
// 其他信息
data.put("jobNo", record.getJobNo());
data.put("phoneNo", maskPhoneNumber(record.getPhoneNo()));
data.put("idNumber", maskIdCard(record.getIdCard()));
data.put("vipTypeName", record.getVipTypeName());
```

## 三、前端实现

### 1. 表格列配置

在人脸进场/出场详情中添加了两列：

```javascript
'face-entry': {
  title: `${this.currentTimeLabel}人脸进场详情`,
  columns: [
    { key: 'personName', label: '姓名' },
    { key: 'channelName', label: '通道名称' },
    { key: 'personType', label: '人员类型' },
    { key: 'department', label: '部门/学院' },
    { key: 'phoneNo', label: '手机号' },        // 新增
    { key: 'idNumber', label: '身份证号' },     // 新增
    { key: 'recognitionMethod', label: '识别方式' },
    { key: 'reservationInfo', label: '预约信息' },
    { key: 'eventTime', label: '进场时间' }
  ]
}
```

### 2. 样式处理

为敏感数据添加了专门的样式类：

```vue
<span v-else-if="col.key === 'phoneNo' || col.key === 'idNumber'" class="sensitive-data">
  {{ row[col.key] || '-' }}
</span>
```

### 3. CSS样式

```css
/* 敏感数据样式 */
.sensitive-data {
  font-family: 'Courier New', monospace;  /* 等宽字体 */
  letter-spacing: 1px;                     /* 字符间距 */
  color: #ffa726;                          /* 橙色文字 */
  background: rgba(255, 167, 38, 0.1);     /* 半透明橙色背景 */
  padding: 2px 6px;                        /* 内边距 */
  border-radius: 3px;                      /* 圆角 */
  font-size: 12px;                         /* 字体大小 */
}
```

**样式特点**：
- 使用等宽字体（Courier New），便于对齐和识别
- 橙色高亮显示，提醒这是敏感信息
- 半透明背景，区分普通字段
- 适当的字符间距，提高可读性

## 四、数据流程

### 1. 数据获取
```
数据库 → AcmsEventRecord实体 → FaceMonitorController
```

### 2. 脱敏处理
```
原始数据 → maskPhoneNumber()/maskIdCard() → 脱敏数据
```

### 3. 返回前端
```json
{
  "phoneNo": "138****5678",
  "idNumber": "110101********1234"
}
```

### 4. 前端展示
```
API响应 → transformDetailData() → 表格渲染 → 样式美化
```

## 五、安全特性

### 1. 后端脱敏
- ✅ 数据在后端接口返回前就已脱敏
- ✅ 前端无法获取完整的敏感信息
- ✅ 即使抓包也只能看到脱敏后的数据

### 2. 前端标识
- ✅ 使用特殊样式标识敏感数据
- ✅ 提醒用户这是经过处理的信息
- ✅ 等宽字体便于识别星号位置

### 3. 数据完整性
- ✅ 原始数据在数据库中保持完整
- ✅ 仅在展示层进行脱敏
- ✅ 不影响数据的实际使用和查询

## 六、使用场景

### 场景1：查看人员进出记录
1. 打开人脸进场/出场详情
2. 表格中显示脱敏后的手机号和身份证号
3. 保留关键信息便于识别，同时保护隐私

### 场景2：数据导出（未来功能）
- 导出的数据也应使用脱敏后的信息
- 避免完整敏感信息外泄

### 场景3：权限控制（未来扩展）
- 可根据用户权限决定是否脱敏
- 管理员可查看完整信息
- 普通用户只能查看脱敏信息

## 七、测试验证

### 1. 手机号测试用例
| 输入 | 预期输出 | 说明 |
|------|---------|------|
| `13812345678` | `138****5678` | 标准11位 |
| `1381234567` | `138****4567` | 10位 |
| `12345` | `12345` | 少于7位，不脱敏 |
| `null` | `` | 空值 |
| `` | `` | 空字符串 |

### 2. 身份证号测试用例
| 输入 | 预期输出 | 说明 |
|------|---------|------|
| `110101199001011234` | `110101********1234` | 18位身份证 |
| `110101900101123` | `110101******123` | 15位身份证 |
| `12345678` | `12345678` | 少于10位，不脱敏 |
| `null` | `` | 空值 |
| `` | `` | 空字符串 |

## 八、注意事项

### 1. 性能考虑
- 脱敏操作在内存中进行，性能影响微乎其微
- 不会影响数据库查询性能

### 2. 数据一致性
- 原始数据在数据库中保持不变
- 脱敏仅在API返回时进行
- 不影响数据的查询和筛选功能

### 3. 国际化支持
- 当前脱敏规则适用于中国手机号和身份证号
- 如需支持其他国家，需调整脱敏规则

### 4. 法律合规
- 符合《个人信息保护法》要求
- 遵循最小化原则，仅展示必要信息
- 保护用户隐私数据

## 九、后续优化建议

### 1. 权限分级
```java
// 根据用户权限决定是否脱敏
if (hasFullAccessPermission(currentUser)) {
    data.put("phoneNo", record.getPhoneNo());
} else {
    data.put("phoneNo", maskPhoneNumber(record.getPhoneNo()));
}
```

### 2. 配置化脱敏规则
- 将脱敏规则配置化，便于调整
- 支持不同字段的不同脱敏策略

### 3. 审计日志
- 记录敏感数据的访问日志
- 追踪谁在何时查看了哪些敏感信息

### 4. 动态脱敏
- 支持前端"显示/隐藏"完整信息
- 需要二次验证（如输入密码）才能查看

## 十、相关文件

### 后端文件
- `FaceMonitorController.java` - 控制器，包含脱敏方法
- `AcmsEventRecord.java` - 实体类，包含敏感字段

### 前端文件
- `src/views/center.vue` - 主视图文件
  - 表格列配置
  - 数据转换逻辑
  - 样式定义

### 文档文件
- `人脸监控详情筛选功能说明.md` - 功能总览
- `敏感数据脱敏功能说明.md` - 本文档
