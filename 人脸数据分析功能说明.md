# 人脸数据分析功能实现说明

## 概述

本次更新实现了基于`acms_event_record`表的人脸数据分析功能，在"通道时段人流分析"模块中展示真实的人脸识别数据，并根据`organization`字段智能分类人员类型。

## 一、后端实现

### 1. 新增控制器：FaceAnalysisController.java

**文件路径：** `d:\nefu-edu-datav\boot-new-20251112\src\main\java\com\parkingmanage\controller\FaceAnalysisController.java`

**核心功能：**

- **通道人流统计** (`/parking/analysis/face/channel-statistics`)
  - 查询`acms_event_record`表中的人脸识别数据
  - 按通道分组统计人数和人群属性分布
  - 支持多种时间范围查询（today、week、month、year）

- **通道详细分析** (`/parking/analysis/face/channel-detail`)
  - 获取指定通道的详细人群属性分布
  - 提供12小时的人流量趋势数据
  - 返回学生、教职工、外来人员、临聘老师的统计数据

### 2. 人员类型分类逻辑

根据`organization`字段进行智能分类：

```java
// organization格式示例：默认组织/野生动物与自然保护地学院/学生/硕士/2024林业2

private String classifyPersonType(String organization) {
    // 分割organization字符串
    String[] parts = organization.split("/");
    String typeInfo = parts[2].trim(); // 第三部分是人员类型
    
    // 关键字匹配
    if (typeInfo.contains("学生") || typeInfo.contains("研究生") || ...) {
        return "学生";
    } else if (typeInfo.contains("教师") || typeInfo.contains("教授") || ...) {
        return "教职工";
    } else if (typeInfo.contains("临聘") || typeInfo.contains("临时") || ...) {
        return "临聘老师";
    } else {
        return "外来人员";
    }
}
```

**分类规则：**

- **学生**：包含"学生"、"研究生"、"本科生"、"硕士"、"博士"等关键字
- **教职工**：包含"教师"、"教授"、"讲师"、"副教授"、"教职工"、"职工"等关键字
- **临聘老师**：包含"临聘"、"临时"、"兼职"等关键字
- **外来人员**：不匹配以上任何类型，或organization字段为空

### 3. API接口

#### 3.1 获取通道人流统计数据

**请求方式：** GET / POST

**接口地址：** `http://localhost:8085/parking/analysis/face/channel-statistics`

**请求参数：**
```json
{
  "timeRange": "today",  // today、week、month、year
  "startTime": "2025-01-01 00:00:00",  // 可选
  "endTime": "2025-01-01 23:59:59"     // 可选
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "channels": [
      {
        "name": "1号门入口",
        "totalCount": 1234,
        "countData": [50, 80, 120, ...],  // 12个时段的人数
        "hours": ["00", "02", "04", ...],
        "typeDistribution": [
          {
            "name": "学生",
            "value": 556,
            "percent": 45
          },
          {
            "name": "教职工",
            "value": 345,
            "percent": 28
          },
          {
            "name": "外来人员",
            "value": 222,
            "percent": 18
          },
          {
            "name": "临聘老师",
            "value": 111,
            "percent": 9
          }
        ],
        "dominantType": "学生45%"
      }
    ],
    "timeRange": "today",
    "dataSource": "DATABASE"
  }
}
```

#### 3.2 获取通道详细分析数据

**请求方式：** POST

**接口地址：** `http://localhost:8085/parking/analysis/face/channel-detail`

**请求参数：**
```json
{
  "channelName": "1号门入口",
  "timeRange": "today",
  "startTime": "2025-01-01 00:00:00",  // 可选
  "endTime": "2025-01-01 23:59:59"     // 可选
}
```

## 二、前端实现

### 1. 组件修改：ChannelFlowAnalysis.vue

**文件路径：** `d:\nefu-edu-datav\vue-big-screen-master\src\components\echart\ChannelFlowAnalysis.vue`

### 2. 主要改动

#### 2.1 表格列顺序调整

**原顺序：** 通道名称 → 人数 → 人群属性分布

**新顺序：** 人数 → 人群属性分布 → 通道名称

```vue
<thead>
  <tr>
    <th style="width: 120px;">人数</th>
    <th style="width: 120px;">人群属性分布</th>
    <th style="width: 200px;">通道名称</th>
  </tr>
</thead>
```

#### 2.2 数据接口对接

```javascript
async loadChannelData() {
  try {
    // 调用人脸数据分析API
    const response = await this.$http.get(
      'http://localhost:8085/parking/analysis/face/channel-statistics', 
      {
        params: {
          timeRange: 'today'
        }
      }
    );
    
    if (response.data && response.data.code === 200 && response.data.data) {
      const apiData = response.data.data;
      const channels = apiData.channels || [];
      
      // 处理数据...
      this.channelData = channels.map((channel, idx) => {
        // 使用后端返回的真实数据
        return {
          name: channel.name,
          totalCount: channel.totalCount,
          countData: channel.countData,
          typeDistribution: { data: channel.typeDistribution },
          // ...
        };
      });
    }
  } catch (error) {
    console.error('加载通道数据失败:', error);
    // 降级到模拟数据
    this.initMockData();
  }
}
```

#### 2.3 人群类型更新

将原来的"男性、女性、儿童、老人"改为"学生、教职工、外来人员、临聘老师"：

```javascript
const crowdTypes = [
  { name: '学生', color: '#3b82f6', icon: '🎓' },
  { name: '教职工', color: '#10b981', icon: '👔' },
  { name: '外来人员', color: '#f59e0b', icon: '🚶' },
  { name: '临聘老师', color: '#ef5da8', icon: '📚' }
];
```

#### 2.4 弹窗详情显示

点击"人群属性分布"后，弹窗显示详细的人员类型统计：

- 12小时人流量柱状图
- 人群属性分布折线图（展示学生、教职工、外来人员、临聘老师的分布）

## 三、数据表结构

### acms_event_record 表

关键字段：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | BIGINT | 主键ID |
| event_id | VARCHAR | 事件ID |
| event_type | INT | 事件类型（197162-人证比对，196893-人脸识别，198914-刷校园卡） |
| person_id | VARCHAR | 人员ID |
| person_name | VARCHAR | 姓名 |
| job_no | VARCHAR | 工号/学号 |
| organization | VARCHAR | 所属单位（用于人员分类） |
| channel_name | VARCHAR | 进出通道名称 |
| direction | VARCHAR | 进出方向 |
| event_time | DATETIME | 事件发生时间 |
| deleted | INT | 逻辑删除标记 |

## 四、部署和测试

### 1. 后端启动

确保后端服务运行在 `http://localhost:8085`

### 2. 前端启动

```bash
cd d:\nefu-edu-datav\vue-big-screen-master
npm run serve
```

### 3. 访问大屏

浏览器访问：`http://localhost:8080`

查看"通道时段人流分析"模块，应该可以看到：
- 表格列顺序已调整（人数、人群属性分布、通道名称）
- 人群属性分布显示学生、教职工、外来人员、临聘老师的数据
- 点击图表后弹窗显示详细的人员类型统计

### 4. 数据验证

如果`acms_event_record`表有数据，应该显示真实统计：
- 每个通道的人流量
- 按小时的人流量分布
- 各类人员的占比统计

如果表中无数据，系统会自动降级到模拟数据模式。

## 五、注意事项

1. **IDE警告：** FaceAnalysisController.java 可能显示包声明警告，这是IDE配置问题，实际包名是正确的，可以忽略。

2. **跨域配置：** 如果前后端分离部署，需要在后端配置CORS允许前端域名访问。

3. **数据刷新：** 组件会每3秒自动刷新数据，可以根据需要调整刷新间隔。

4. **性能优化：** 如果`acms_event_record`表数据量很大，建议：
   - 添加索引：`event_time`、`channel_name`、`deleted`
   - 使用分页查询
   - 考虑缓存热点数据

5. **Organization字段格式：** 确保`organization`字段格式规范，便于准确分类人员类型。

## 六、功能特性

✅ **真实数据驱动**：直接从`acms_event_record`表读取人脸识别数据

✅ **智能分类**：基于`organization`字段自动分类人员类型

✅ **多维度统计**：支持按通道、时段、人员类型等多维度统计

✅ **实时更新**：数据自动刷新，保持最新状态

✅ **降级处理**：数据异常时自动切换到模拟数据

✅ **交互友好**：点击图表查看详细统计信息

## 七、后续扩展

可以考虑的功能扩展：

1. 增加更多时间范围选项（自定义日期范围）
2. 支持导出统计报表
3. 增加异常检测和告警功能
4. 添加人员进出记录明细查询
5. 支持多通道对比分析
6. 增加访客预约关联分析

---

**开发完成时间：** 2025-01-17

**开发者：** Cascade AI Assistant
