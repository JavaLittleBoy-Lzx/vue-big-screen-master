# CORSè·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

å‰ç«¯ç›´æ¥è°ƒç”¨è¿œç¨‹è¿è§„ç»Ÿè®¡æ¥å£æ—¶ï¼Œé‡åˆ°CORSè·¨åŸŸé”™è¯¯ï¼š

```
Access to XMLHttpRequest at 'https://localhost:8543/parking/violations' 
from origin 'http://localhost:6954' has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

## åŸå› åˆ†æ

1. **æµè§ˆå™¨åŒæºç­–ç•¥**ï¼šæµè§ˆå™¨å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œé™åˆ¶è·¨åŸŸHTTPè¯·æ±‚
2. **è¿œç¨‹æœåŠ¡å™¨é…ç½®**ï¼š`localhost:8543` æœªè®¾ç½®å…è®¸è·¨åŸŸçš„å“åº”å¤´
3. **åè®®/åŸŸå/ç«¯å£ä¸åŒ**ï¼šæœ¬åœ° `http://localhost:6954` ä¸è¿œç¨‹ `https://localhost:8543` ä¸åŒæº

## è§£å†³æ–¹æ¡ˆï¼šåç«¯ä»£ç†

### æ ¸å¿ƒæ€è·¯
**ç”±åç«¯æœåŠ¡å™¨ä»£ç†è°ƒç”¨è¿œç¨‹æ¥å£**ï¼Œé¿å…æµè§ˆå™¨è·¨åŸŸé™åˆ¶ï¼š

```
å‰ç«¯ â†’ æœ¬åœ°åç«¯ â†’ è¿œç¨‹API
(åŒåŸŸ)   (æœåŠ¡å™¨é—´é€šä¿¡ï¼Œæ— è·¨åŸŸé™åˆ¶)
```

### å®ç°æ­¥éª¤

#### 1. åç«¯æ·»åŠ ä»£ç†æ¥å£

**æ–‡ä»¶**: `StatisticsController.java`

**æ–°å¢æ¥å£**:
```java
@GetMapping("/violations")
public Result<Integer> getViolations(
        @RequestParam String startDate,
        @RequestParam String endDate) {
    
    // è°ƒç”¨è¿œç¨‹API
    String url = "https://localhost:8543/parking/violations?page=1&size=1&community=ä¸œåŒ—æ—ä¸šå¤§å­¦&startDate={startDate}&endDate={endDate}";
    
    ResponseEntity<String> response = restTemplate.exchange(
        url, HttpMethod.GET, entity, String.class, startDate, endDate
    );
    
    // è§£æå¹¶è¿”å›ç»“æœ
    return Result.success(total);
}
```

#### 2. é…ç½®RestTemplate

**æ–‡ä»¶**: `WebConfig.java`

**æ·»åŠ Bean**:
```java
@Bean
public RestTemplate restTemplate() {
    SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory();
    factory.setConnectTimeout(10000);  // è¿æ¥è¶…æ—¶10ç§’
    factory.setReadTimeout(30000);     // è¯»å–è¶…æ—¶30ç§’
    return new RestTemplate(factory);
}
```

#### 3. å‰ç«¯è°ƒç”¨æœ¬åœ°æ¥å£

**æ–‡ä»¶**: `center.vue`

**ä¿®æ”¹å‰**:
```javascript
// âŒ ç›´æ¥è°ƒç”¨è¿œç¨‹æ¥å£ï¼Œä¼šè¢«CORSé˜»æ­¢
const response = await axios.get('https://localhost:8543/parking/violations', {
  params: { ... }
});
```

**ä¿®æ”¹å**:
```javascript
// âœ… è°ƒç”¨æœ¬åœ°åç«¯ä»£ç†æ¥å£
const response = await axios.get('http://localhost:8675/parking/statistics/violations', {
  params: { startDate, endDate }
});
```

## æŠ€æœ¯ç»†èŠ‚

### 1. RestTemplateé…ç½®

- **è¿æ¥è¶…æ—¶**: 10ç§’ï¼ˆå»ºç«‹è¿æ¥çš„æœ€é•¿æ—¶é—´ï¼‰
- **è¯»å–è¶…æ—¶**: 30ç§’ï¼ˆç­‰å¾…å“åº”æ•°æ®çš„æœ€é•¿æ—¶é—´ï¼‰
- **å·¥å‚ç±»å‹**: `SimpleClientHttpRequestFactory`ï¼ˆSpringé»˜è®¤å®ç°ï¼‰

### 2. å“åº”è§£æ

ä½¿ç”¨FastJSONè§£æè¿œç¨‹APIè¿”å›çš„JSONï¼š

```java
JSONObject jsonObject = JSONObject.parseObject(body);
JSONObject data = jsonObject.getJSONObject("data");
Integer total = data.getInteger("total");
```

### 3. é”™è¯¯å¤„ç†

- **ç½‘ç»œå¼‚å¸¸**: æ•è·å¼‚å¸¸å¹¶è¿”å›0ï¼Œä¸å½±å“å…¶ä»–æ•°æ®åŠ è½½
- **é200çŠ¶æ€**: è¿”å›0
- **æ•°æ®è§£æå¤±è´¥**: è¿”å›0

```java
catch (Exception e) {
    log.error("âŒ [è¿è§„ç»Ÿè®¡ä»£ç†] è°ƒç”¨å¤±è´¥", e);
    return Result.success(0); // å¤±è´¥æ—¶è¿”å›0
}
```

## ä¼˜åŠ¿å¯¹æ¯”

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **åç«¯ä»£ç†** âœ… | å½»åº•è§£å†³è·¨åŸŸ<br>ç»Ÿä¸€ç®¡ç†<br>å¯ç¼“å­˜ä¼˜åŒ– | éœ€è¦åç«¯æ”¯æŒ | ç”Ÿäº§ç¯å¢ƒæ¨è |
| å‰ç«¯CORSé…ç½® | ç®€å•å¿«é€Ÿ | éœ€è¿œç¨‹æœåŠ¡å™¨é…ç½®<br>å®‰å…¨æ€§ä½ | æœ¬åœ°å¼€å‘æµ‹è¯• |
| JSONP | æ— éœ€æœåŠ¡å™¨é…ç½® | åªæ”¯æŒGET<br>å®‰å…¨é£é™© | å·²è¿‡æ—¶ |
| æµè§ˆå™¨æ’ä»¶ | å¼€å‘è°ƒè¯•æ–¹ä¾¿ | ä»…æœ¬åœ°æœ‰æ•ˆ | ä»…å¼€å‘ç¯å¢ƒ |

### åç«¯ä»£ç†ä¼˜åŠ¿

1. âœ… **å½»åº•è§£å†³è·¨åŸŸ**: æœåŠ¡å™¨é—´é€šä¿¡æ— è·¨åŸŸé™åˆ¶
2. âœ… **ç»Ÿä¸€ç®¡ç†**: é›†ä¸­ç®¡ç†è¿œç¨‹APIè°ƒç”¨
3. âœ… **å®‰å…¨æ€§é«˜**: éšè—çœŸå®APIåœ°å€å’Œå‚æ•°
4. âœ… **å¯æ‰©å±•**: å¯æ·»åŠ ç¼“å­˜ã€é‡è¯•ã€é™çº§ç­‰é€»è¾‘
5. âœ… **æ—¥å¿—è®°å½•**: å®Œæ•´çš„è¯·æ±‚/å“åº”æ—¥å¿—
6. âœ… **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

## æ¥å£è°ƒç”¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      HTTP      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTPS    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ æœ¬åœ°åç«¯ä»£ç† â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ è¿œç¨‹è¿è§„API     â”‚
â”‚ Vue.js  â”‚  localhost    â”‚ Spring Boot  â”‚  äº’è”ç½‘    â”‚ xuerparking.cn  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  æ— è·¨åŸŸé™åˆ¶    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  æ— è·¨åŸŸé™åˆ¶  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘                            â”‚                              â”‚
    â”‚         Result<Integer>    â”‚         JSON Response        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                ç»Ÿè®¡ç»“æœ           è§£æå¹¶åŒ…è£…
```

## æµ‹è¯•éªŒè¯

### 1. æ£€æŸ¥åç«¯æ¥å£

```bash
curl "http://localhost:8675/parking/statistics/violations?startDate=2025-11-18%2000:00:00&endDate=2025-11-18%2023:59:59"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": "0",
  "msg": "success",
  "data": 3
}
```

### 2. æŸ¥çœ‹åç«¯æ—¥å¿—

```
ğŸ“Š [è¿è§„ç»Ÿè®¡ä»£ç†] å¼€å§‹æŸ¥è¯¢: 2025-11-18 00:00:00 - 2025-11-18 23:59:59
âœ… [è¿è§„ç»Ÿè®¡ä»£ç†] æŸ¥è¯¢å®Œæˆ: 3 èµ·
```

### 3. æ£€æŸ¥å‰ç«¯æ§åˆ¶å°

- âŒ ä¸å†å‡ºç°CORSé”™è¯¯
- âœ… æˆåŠŸè·å–è¿è§„ç»Ÿè®¡æ•°æ®
- âœ… æ­£å¸¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š

## æ³¨æ„äº‹é¡¹

### 1. è¶…æ—¶é…ç½®

æ ¹æ®è¿œç¨‹APIå“åº”æ—¶é—´è°ƒæ•´ï¼š
```java
factory.setConnectTimeout(10000);  // å¯å¢åŠ åˆ°15000
factory.setReadTimeout(30000);     // å¯å¢åŠ åˆ°60000
```

### 2. SSLè¯ä¹¦é—®é¢˜

å¦‚æœè¿œç¨‹APIä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œå¯èƒ½éœ€è¦é…ç½®ä¿¡ä»»ï¼š
```java
// ä¸æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨
// ä»…å¼€å‘æµ‹è¯•æ—¶å¯ä¸´æ—¶å¿½ç•¥SSLéªŒè¯
```

### 3. å‚æ•°ç¼–ç 

ç¡®ä¿ä¸­æ–‡å‚æ•°æ­£ç¡®ç¼–ç ï¼š
```java
community=ä¸œåŒ—æ—ä¸šå¤§å­¦
// URLç¼–ç å: community=%E4%B8%9C%E5%8C%97%E6%9E%97%E4%B8%9A%E5%A4%A7%E5%AD%A6
```

### 4. é”™è¯¯é‡è¯•

å¯åœ¨ä»£ç†å±‚æ·»åŠ é‡è¯•é€»è¾‘ï¼š
```java
@Retryable(maxAttempts = 3, backoff = @Backoff(delay = 1000))
public Result<Integer> getViolations(...) {
    // è°ƒç”¨è¿œç¨‹API
}
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç»“æœç¼“å­˜

```java
@Cacheable(value = "violations", key = "#startDate + '-' + #endDate")
public Result<Integer> getViolations(String startDate, String endDate) {
    // ç¼“å­˜5åˆ†é’Ÿï¼Œå‡å°‘è¿œç¨‹è°ƒç”¨
}
```

### 2. å¼‚æ­¥è°ƒç”¨

å¯¹äºéå…³é”®æ•°æ®ï¼Œå¯ä»¥å¼‚æ­¥åŠ è½½ï¼š
```java
@Async
public CompletableFuture<Integer> getViolationsAsync(...) {
    // å¼‚æ­¥è°ƒç”¨ï¼Œä¸é˜»å¡ä¸»æµç¨‹
}
```

### 3. é™çº§å¤„ç†

å½“è¿œç¨‹APIä¸å¯ç”¨æ—¶ï¼Œè¿”å›é»˜è®¤å€¼ï¼š
```java
catch (Exception e) {
    log.error("è¿œç¨‹APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ•°æ®");
    return Result.success(0); // æˆ–è¿”å›ç¼“å­˜çš„å†å²æ•°æ®
}
```

## å…¶ä»–è·¨åŸŸæ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1: é…ç½®è¿œç¨‹æœåŠ¡å™¨CORS

**ä¼˜ç‚¹**: å‰ç«¯ç›´è¿ï¼Œæ— éœ€ä»£ç†  
**ç¼ºç‚¹**: éœ€è¦è¿œç¨‹æœåŠ¡å™¨ç®¡ç†å‘˜é…ç½®  
**å®æ–½**: éœ€è¦åœ¨ `localhost:8543` æ·»åŠ å“åº”å¤´

```java
// è¿œç¨‹æœåŠ¡å™¨éœ€è¦æ·»åŠ 
response.setHeader("Access-Control-Allow-Origin", "*");
```

### æ–¹æ¡ˆ2: Nginxåå‘ä»£ç†

**ä¼˜ç‚¹**: é›†ä¸­ç®¡ç†å¤šä¸ªAPI  
**ç¼ºç‚¹**: éœ€è¦é¢å¤–çš„Nginxé…ç½®  
**å®æ–½**: é…ç½®Nginxä»£ç†è§„åˆ™

```nginx
location /api/violations {
    proxy_pass https://localhost:8543/parking/violations;
}
```

### æ–¹æ¡ˆ3: å¼€å‘ç¯å¢ƒä»£ç†

**ä¼˜ç‚¹**: å¼€å‘å¿«é€Ÿ  
**ç¼ºç‚¹**: ä»…é™å¼€å‘ç¯å¢ƒ  
**å®æ–½**: Vueé…ç½®æ–‡ä»¶

```javascript
// vue.config.js
devServer: {
  proxy: {
    '/api': {
      target: 'https://localhost:8543',
      changeOrigin: true
    }
  }
}
```

## æ€»ç»“

âœ… **æ¨èæ–¹æ¡ˆ**: åç«¯ä»£ç†ï¼ˆå·²å®ç°ï¼‰  
âœ… **ä¼˜åŠ¿**: å½»åº•è§£å†³è·¨åŸŸï¼Œç”Ÿäº§ç¯å¢ƒå¯ç”¨  
âœ… **å®ç°ç®€å•**: åªéœ€æ·»åŠ ä¸€ä¸ªæ¥å£å’ŒBeané…ç½®  
âœ… **æ‰©å±•æ€§å¼º**: å¯æ·»åŠ ç¼“å­˜ã€é‡è¯•ã€é™çº§ç­‰åŠŸèƒ½  

---

**æ›´æ–°æ—¶é—´**: 2025-11-18  
**è§£å†³çŠ¶æ€**: âœ… å·²è§£å†³
