# 计划看板添加进出场时间说明

## 修改目的

在计划看板详情弹窗的表格中添加**进场时间**和**离场时间**两列，显示访客和车辆的实际进出场时间。

## 修改内容

### 1. 后端修改

**文件**: `VisitorPlanDashboardController.java`

**修改位置**: 第187-188行

**修改内容**:
```java
item.put("personVisitTimes", r.getPersonVisitTimes());
item.put("carVisitTimes", r.getCarVisitTimes());
```

**说明**: 
- 添加 `personVisitTimes` 字段（人员进出场时间，JSON格式）
- 添加 `carVisitTimes` 字段（车辆进出场时间，JSON格式）

### 2. 前端修改

**文件**: `VisitorPlanDashboard.vue`

#### 2.1 表头修改（第51-64行）

添加两列：
```vue
<th>进场时间</th>
<th>离场时间</th>
```

完整表头顺序：
1. 序号
2. 访客姓名
3. 手机号
4. 车牌号（仅车辆类型显示）
5. 被访人
6. 被访部门
7. 开始时间（预约时间）
8. 结束时间（预约时间）
9. **进场时间**（新增）
10. **离场时间**（新增）
11. 来访状态

#### 2.2 表体修改（第66-83行）

添加进出场时间显示：
```vue
<td>{{ getEntryTime(item) }}</td>
<td>{{ getExitTime(item) }}</td>
```

#### 2.3 新增方法（第596-626行）

添加两个方法用于解析JSON格式的进出场时间：

**获取进场时间方法**:
```javascript
getEntryTime(item) {
  const timesJson = this.modalType === 'vehicle' ? item.carVisitTimes : item.personVisitTimes;
  if (!timesJson) return '-';
  
  try {
    const times = JSON.parse(timesJson);
    if (times && times.entryTime) {
      return this.formatTime(times.entryTime);
    }
  } catch (e) {
    console.error('解析进场时间失败:', e);
  }
  return '-';
}
```

**获取离场时间方法**:
```javascript
getExitTime(item) {
  const timesJson = this.modalType === 'vehicle' ? item.carVisitTimes : item.personVisitTimes;
  if (!timesJson) return '-';
  
  try {
    const times = JSON.parse(timesJson);
    if (times && times.exitTime) {
      return this.formatTime(times.exitTime);
    }
  } catch (e) {
    console.error('解析离场时间失败:', e);
  }
  return '-';
}
```

## 数据格式

### JSON 时间数据格式

**人员进出场时间** (`personVisitTimes`):
```json
{
  "entryTime": "2025-11-26T08:48:00",
  "exitTime": "2025-11-26T23:59:00"
}
```

**车辆进出场时间** (`carVisitTimes`):
```json
{
  "entryTime": "2025-11-26T08:00:00",
  "exitTime": "2025-11-26T20:00:00"
}
```

### 显示格式

原始时间格式: `2025-11-26T08:48:00`  
显示格式: `11-26 08:48`

## 功能逻辑

### 1. 访客类型 (visitor)
- 读取 `personVisitTimes` 字段
- 解析JSON获取 `entryTime` 和 `exitTime`
- 格式化后显示在表格中

### 2. 车辆类型 (vehicle)
- 读取 `carVisitTimes` 字段
- 解析JSON获取 `entryTime` 和 `exitTime`
- 格式化后显示在表格中

### 3. 异常处理
- 如果时间字段为空，显示 `-`
- JSON解析失败时，显示 `-` 并输出错误日志
- 时间值不存在时，显示 `-`

## 测试步骤

### 1. 启动后端服务
```bash
cd d:\nefu-edu-datav\boot-new-20251112
mvn clean package
mvn spring-boot:run
```

### 2. 启动前端服务
```bash
cd d:\nefu-edu-datav\vue-big-screen-master
npm run serve
```

### 3. 测试访客详情

#### 准备测试数据
在数据库中插入测试数据：
```sql
UPDATE visitor_reservation_sync 
SET person_visit_times = '{"entryTime":"2025-11-26T08:48:00","exitTime":"2025-11-26T21:35:00"}'
WHERE id = 1;
```

#### 测试步骤
1. 打开大屏页面
2. 点击"计划访客"水波图
3. 查看详情弹窗表格
4. 验证进场时间和离场时间列是否显示

**预期结果**:
| 序号 | 访客姓名 | ... | 进场时间 | 离场时间 | 来访状态 |
|------|----------|-----|----------|----------|----------|
| 1    | 魏尘宗   | ... | 11-26 08:48 | 11-26 21:35 | 人已进场 |

### 4. 测试车辆详情

#### 准备测试数据
```sql
UPDATE visitor_reservation_sync 
SET car_visit_times = '{"entryTime":"2025-11-26T08:00:00","exitTime":"2025-11-26T18:00:00"}'
WHERE id = 6 AND car_number IS NOT NULL;
```

#### 测试步骤
1. 点击"预计车辆"水波图
2. 查看详情弹窗表格
3. 验证进场时间和离场时间列是否显示

**预期结果**:
| 序号 | 访客姓名 | 车牌号 | ... | 进场时间 | 离场时间 | 来访状态 |
|------|----------|--------|-----|----------|----------|----------|
| 1    | 金洪全   | 辽俗车  | ... | 11-26 08:00 | 11-26 18:00 | 车已进场 |

## 边界情况处理

### 1. 空值处理
- `personVisitTimes` 为 null → 显示 `-`
- `carVisitTimes` 为 null → 显示 `-`

### 2. JSON格式错误
- JSON解析失败 → 显示 `-`，控制台输出错误日志

### 3. 部分时间缺失
- 有进场时间，无离场时间 → 进场时间正常显示，离场时间显示 `-`
- 无进场时间，有离场时间 → 进场时间显示 `-`，离场时间正常显示

### 4. 未来访记录
- 未进场的记录（已被过滤，不会显示在列表中）

## API 响应示例

### 访客类型响应
```json
{
  "code": "0",
  "data": {
    "list": [
      {
        "id": 1,
        "visitorName": "魏尘宗",
        "visitorPhone": "13134510131",
        "personVisitStatus": "人已进场",
        "personVisitTimes": "{\"entryTime\":\"2025-11-26T08:48:00\",\"exitTime\":\"2025-11-26T21:35:00\"}",
        "startTime": "2025-11-26T17:35:00",
        "endTime": "2025-11-26T21:35:00"
      }
    ],
    "total": 1,
    "type": "visitor"
  }
}
```

### 车辆类型响应
```json
{
  "code": "0",
  "data": {
    "list": [
      {
        "id": 6,
        "visitorName": "金洪全",
        "carNumber": "辽俗车",
        "carVisitStatus": "车已进场",
        "carVisitTimes": "{\"entryTime\":\"2025-11-26T08:00:00\",\"exitTime\":\"2025-11-26T18:00:00\"}",
        "startTime": "2025-11-26T16:00:00",
        "endTime": "2025-11-26T18:00:00"
      }
    ],
    "total": 1,
    "type": "vehicle"
  }
}
```

## 表格列宽调整建议

由于增加了两列，建议调整CSS样式以优化显示效果：

```scss
.detail-table {
  th, td {
    // 序号列窄一些
    &:nth-child(1) { width: 50px; }
    
    // 时间列固定宽度
    &:nth-child(7), // 开始时间
    &:nth-child(8), // 结束时间
    &:nth-child(9), // 进场时间
    &:nth-child(10) { // 离场时间
      width: 110px;
      white-space: nowrap;
    }
    
    // 状态列
    &:last-child {
      width: 100px;
    }
  }
}
```

## 注意事项

1. **时间字段格式**
   - 后端返回的是JSON字符串，不是JSON对象
   - 前端需要使用 `JSON.parse()` 解析

2. **错误处理**
   - 必须使用 try-catch 包裹 JSON.parse()
   - 避免解析失败导致页面崩溃

3. **字段判断**
   - 根据 `modalType` 判断使用哪个时间字段
   - visitor → personVisitTimes
   - vehicle → carVisitTimes

4. **时间格式统一**
   - 复用现有的 `formatTime()` 方法
   - 保持时间显示格式一致

## 相关文件

- **后端控制器**: `/src/main/java/com/parkingmanage/controller/VisitorPlanDashboardController.java`
- **前端组件**: `/src/views/VisitorPlanDashboard.vue`
- **实体类**: `/src/main/java/com/parkingmanage/entity/VisitorReservationSync.java`

## 修改完成时间

2025-11-26 10:45

## 关联文档

- [计划看板详情弹窗过滤功能说明.md](../boot-new-20251112/计划看板详情弹窗过滤功能说明.md) - 只显示来访记录的过滤逻辑
