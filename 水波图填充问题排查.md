# 水波图填充问题排查

## 问题现象

今日计划看板中的水波图：
- ✅ 显示了正确的数字（12和9）
- ❌ 但是没有看到水波填充效果
- ❌ 圆圈是空的，没有颜色

## 可能原因分析

### 原因1：百分比太低（最可能）

你的数据：
- 访客：12/326 = **3.68%**
- 车辆：9/306 = **2.94%**

这么低的百分比，水波只填充圆圈底部很小一部分（约3-4像素），在深色背景下**几乎看不见**！

**视觉示意**：
```
┌─────────────┐
│             │  ← 空的部分（96%）
│             │
│             │
│▓            │  ← 填充部分（只有4%！）
└─────────────┘
```

### 原因2：水波图没有正确更新

初始化时数据是0，后续更新可能没有触发。

### 原因3：@antv/g2plot 库问题

可能是水波图组件本身的渲染问题。

## 排查步骤

### 步骤1：刷新页面并查看控制台

按 `Ctrl + F5` 刷新，查看控制台日志。

**期望看到的日志**：

```
📊 [今日计划看板] 开始加载统计数据...
✅ [今日计划看板] 检测到嵌套结构
✅ [今日计划看板] 数据加载成功 {访客: "12/326", 车辆: "9/306"}
🎨 [今日计划看板] 初始化访客水波图 {进度: "3.68% (0.0368)", ...}
🔄 [今日计划看板] 更新水波图 {访客: "12/326 = 3.68% (0.0368)", ...}
✅ 访客水波图已更新
✅ 车辆水波图已更新
```

**如果看到**：
- ❌ `visitorChart 不存在` → 水波图没有初始化成功
- ❌ 进度是 `0% (0)` → 数据没有正确加载

### 步骤2：检查元素

1. 按 `F12` 打开开发者工具
2. 点击"Elements"（元素）标签
3. 找到水波图的DOM元素
4. 查看是否有 `<canvas>` 元素

**正常情况**：
```html
<div class="liquid-chart visitor-chart">
  <canvas width="140" height="140"></canvas>
</div>
```

### 步骤3：测试更高百分比

为了验证水波图功能是否正常，可以临时修改一些测试数据，让百分比提高到可见范围。

**修改数据库数据**：
```sql
-- 将更多预约的人员状态改为"已进场"
UPDATE visitor_reservation_sync
SET person_visit_status = '人已进场'
WHERE id IN (
  SELECT id FROM visitor_reservation_sync
  WHERE start_time <= NOW()
    AND end_time >= NOW()
    AND deleted = 0
  LIMIT 150  -- 改150条，让占比达到 ~46%
);
```

刷新页面后，应该能看到明显的水波填充效果（约一半）。

## 解决方案

### 方案1：添加最小填充阈值（推荐）

修改水波图配置，设置最小可见高度：

```javascript
initVisitorChart() {
  const progress = this.visitorProgress / 100;
  // 如果百分比太低，设置最小可见值（10%）
  const minVisiblePercent = 0.10;  // 至少10%才能看清
  const displayProgress = Math.max(progress, minVisiblePercent);
  
  this.visitorChart = new Liquid(container, {
    percent: displayProgress,  // 使用调整后的百分比
    // ... 其他配置
  });
}
```

**优点**：
- 低百分比时也能看到填充
- 数字仍然显示真实值

**缺点**：
- 视觉上的百分比和数字不完全匹配

### 方案2：使用渐变背景替代低百分比

当百分比低于10%时，用渐变背景代替水波图：

```javascript
if (progress < 0.10) {
  // 使用进度环代替水波图
  // 或显示一个小的指示器
} else {
  // 正常显示水波图
}
```

### 方案3：调整水波图样式增强可见度

```javascript
liquidStyle: {
  fill: '#00ff88',
  opacity: 1,  // 确保不透明
},
// 添加底部高亮
wave: {
  count: 3,
  length: 128,
},
```

### 方案4：添加文字说明

在水波图下方显示具体的百分比：

```vue
<div class="chart-section">
  <div class="liquid-chart visitor-chart" ref="visitorChart"></div>
  <div class="progress-text">{{ visitorStats.percentage }}%</div>
</div>
```

## 快速测试

### 测试1：控制台手动更新

在浏览器控制台执行：

```javascript
// 模拟50%的数据
const mockStats = {
  total: 100,
  completed: 50,
  pending: 50,
  percentage: 50
};

// 手动触发更新（这需要访问Vue实例）
// 如果你能访问到组件实例，可以这样测试
```

### 测试2：修改代码临时测试

临时修改 `loadStatistics` 方法，模拟高百分比：

```javascript
// 临时测试代码
this.visitorStats = {
  total: 100,
  completed: 50,  // 50%应该能明显看到
  pending: 50,
  percentage: 50
};
```

刷新页面，应该能看到水波填充到一半。

## 预期效果对比

### 3.68% 填充（当前）
```
┌───────────┐
│           │
│           │
│           │
│▓▓         │  ← 只有底部一点点
└───────────┘
```

### 50% 填充（测试用）
```
┌───────────┐
│           │
│~~~~~~~~~~~│  ← 水波在中间
│▓▓▓▓▓▓▓▓▓▓▓│
└───────────┘
```

### 80% 填充（理想状态）
```
┌───────────┐
│~~~~~~~~~~~│  ← 水波在上部
│▓▓▓▓▓▓▓▓▓▓▓│
│▓▓▓▓▓▓▓▓▓▓▓│
└───────────┘
```

## 建议

### 短期解决方案

1. **添加百分比文字显示**：在水波图下方显示 "3.7%" 让用户知道填充很少
2. **调整颜色亮度**：使用更亮的颜色，让低百分比也能看清

### 长期解决方案

1. **使用其他图表类型**：当百分比<10%时，使用进度环或进度条
2. **改变统计口径**：统计"今日"而不是"当前时刻"的预约，这样数字会更多

## 总结

### ✅ 数据正确

- 数字显示正确（12和9）
- 百分比计算正确（3.68%和2.94%）
- API调用成功

### ⚠️ 视觉问题

- 百分比太低（<4%）
- 水波填充在底部很小一部分
- 深色背景下几乎看不见

### 🔧 推荐行动

1. **验证功能正常**：修改数据库增加"已进场"的记录，测试水波图
2. **改进UI**：添加百分比文字显示
3. **调整颜色**：使用更亮、更明显的颜色

---

**问题状态**：功能正常，仅视觉效果不明显  
**优先级**：低（非功能性问题）  
**建议修复时间**：1-2小时
