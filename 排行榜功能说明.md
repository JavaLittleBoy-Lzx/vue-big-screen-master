# 智慧停车大屏 - 排行榜功能说明

## 📋 功能概述

在智慧停车大屏中新增了**违规排行榜**和**进出频次排行榜**两个数据分析功能，通过弹窗形式展示，帮助管理员快速发现异常车辆和高频通道。

---

## 🎯 功能入口

### 入口1：时间选择器右侧的"数据分析"菜单（主入口）
位置：页面顶部，时间选择器（今日/本周/本月/今年）的右侧

```
[今日] [本周] [本月] [今年]        [📊 数据分析 ▼]
                                      ├─ 🏆 违规排行榜
                                      └─ 🔄 进出频次排行
```

### 入口2：违规KPI卡片上的快捷链接
位置：违规KPI卡片底部（鼠标悬停时显示）

```
⚠️ 今日违规

     15 起

[🏆 查看排行]  ← 点击快捷打开违规排行榜
```

---

## 🏆 功能一：违规排行榜

### 功能说明
统计指定时间范围内车辆违规次数，按违规次数或最近违规时间排序。

### 数据来源
- **API**: `https://www.xuerparking.cn:8543/parking/violations`
- **参数**: 
  - `startDate`: 开始时间（根据时间选择器）
  - `endDate`: 结束时间
  - `community`: 东北林业大学
  - `size`: 100000（获取全部数据进行统计）

### 统计逻辑
1. 获取所有违规记录
2. 按车牌号分组
3. 统计每个车牌的违规次数
4. 记录最近一次违规时间
5. 按选择的排序方式排序

### 工具栏选项
- **排序方式**：
  - 违规次数（默认）
  - 最近违规时间
- **显示数量**：
  - 前10名（默认）
  - 前20名
  - 前50名

### 表格列说明
| 列名 | 说明 | 特殊显示 |
|------|------|----------|
| 排名 | 1-N | 前三名显示奖牌图标 🥇🥈🥉 |
| 车牌号 | 车牌号码 | 蓝色高亮，等宽字体 |
| 业主信息 | 车主姓名、手机号、VIP类型 | 多行显示，不同颜色区分 |
| 违规次数 | 统计的违规总次数 | 紫色徽章显示 |
| 最近违规 | 最后一次违规的时间 | 相对时间（如"2小时前"） |
| 操作 | 查看详情按钮 | 点击查看该车辆所有违规记录 |

### 特色功能
- **前三名高亮**：排名前三的行有特殊背景色
- **点击查看详情**：点击"查看详情"按钮，自动关闭排行榜并打开该车辆的违规详情列表

---

## 🔄 功能二：进出频次排行榜

### 功能说明
统计指定时间范围内车辆或通道的进出频次，支持两种维度切换。

### 数据来源
- **进场记录API**: `http://www.xuerparking.cn:8675/parking/vehicle-records/entry`
- **出场记录API**: `http://www.xuerparking.cn:8675/parking/vehicle-records/exit`
- **参数**: 
  - `startDate`: 开始时间
  - `endDate`: 结束时间
  - `page`: 1
  - `size`: 100000

### 维度切换

#### 🚗 车辆维度
统计每个车辆的进出次数。

**表格列说明**：
| 列名 | 说明 | 特殊标记 |
|------|------|----------|
| 排名 | 1-N | 前三名奖牌显示 |
| 车牌号 | 车牌号码 | 异常车辆标记⚠️ |
| 业主信息 | 车主姓名、手机号、VIP类型 | 多行显示，不同颜色区分 |
| 进场次数 | 进场记录数 | - |
| 出场次数 | 出场记录数 | - |
| 总次数 | 进+出总次数 | 紫色徽章 |
| 操作 | 查看详情 | - |

**异常检测逻辑**：
```javascript
// 满足以下任一条件标记为异常
1. 进出次数差异 > 5次
2. 总进出次数 > 50次
```

#### 🚪 通道维度
统计每个通道的流量。

**表格列说明**：
| 列名 | 说明 |
|------|------|
| 排名 | 1-N |
| 通道名称 | 进场或出场通道 |
| 进场次数 | 该通道进场车辆数 |
| 出场次数 | 该通道出场车辆数 |
| 总次数 | 总流量 |
| 操作 | 查看详情 |

### 工具栏选项
- **维度切换**：车辆维度 / 通道维度
- **显示数量**：前10名 / 前20名 / 前50名

---

## 🎨 UI设计特点

### 视觉效果
- **科技感背景**：半透明深色背景 + 模糊效果
- **渐变边框**：蓝色/紫色渐变边框
- **奖牌图标**：前三名使用🥇🥈🥉图标
- **徽章样式**：次数统计使用圆角徽章显示
- **悬停动画**：鼠标悬停有平滑的过渡效果

### 响应式设计
- **弹窗大小**：90%宽度，最大1000px
- **最大高度**：85vh（防止超出屏幕）
- **滚动支持**：内容区域支持垂直滚动

### 动画效果
- **打开动画**：渐显 + 向上滑入
- **关闭动画**：渐隐
- **下拉菜单**：平滑展开/收起
- **行悬停**：向右平移 + 阴影增强

---

## 💻 代码结构

### 新增模板部分
```vue
<!-- 1. 时间选择器中的数据分析菜单 -->
<div class="analysis-menu">...</div>

<!-- 2. 违规KPI卡片中的快捷链接 -->
<div class="kpi-quick-link">...</div>

<!-- 3. 排行榜弹窗 -->
<div v-if="showRankingModal" class="ranking-modal-mask">...</div>
```

### 新增data变量
```javascript
showAnalysisMenu: false,      // 分析菜单显示状态
showRankingModal: false,       // 排行榜弹窗显示状态
rankingType: 'violation',      // 类型：violation | frequency
rankingData: [],               // 排行榜数据
rankingLoading: false,         // 加载状态
rankingSortBy: 'count',        // 排序方式
rankingLimit: 20,              // 显示数量
frequencyDimension: 'vehicle', // 频次维度：vehicle | channel
```

### 核心方法
```javascript
// 菜单控制
toggleAnalysisMenu()           // 切换分析菜单
openRankingModal(type)         // 打开排行榜弹窗
closeRankingModal()            // 关闭排行榜弹窗

// 数据加载
loadRankingData()              // 加载排行榜数据（入口）
loadViolationRanking()         // 加载违规排行
loadFrequencyRanking()         // 加载频次排行（入口）
loadVehicleFrequencyRanking()  // 加载车辆频次排行
loadChannelFrequencyRanking()  // 加载通道频次排行

// 详情查看
showViolationDetail(item)      // 查看违规详情
showFrequencyDetail(item)      // 查看频次详情（待实现）
showChannelDetail(item)        // 查看通道详情（待实现）

// 工具方法
formatTime(timeStr)            // 格式化时间显示
```

---

## 🔧 使用说明

### 查看违规排行榜
1. 点击页面右上角"📊 数据分析" → 选择"🏆 违规排行榜"
2. 或者鼠标悬停在"违规"KPI卡片上 → 点击底部"🏆 查看排行"
3. 在弹窗中可以：
   - 切换排序方式（违规次数/最近违规时间）
   - 调整显示数量（前10/20/50名）
   - 点击"查看详情"查看该车辆所有违规记录

### 查看进出频次排行
1. 点击页面右上角"📊 数据分析" → 选择"🔄 进出频次排行"
2. 在弹窗中可以：
   - 切换维度（车辆维度/通道维度）
   - 调整显示数量
   - 查看异常标记（车辆维度下）
   - 点击"查看详情"（功能待完善）

### 时间范围说明
- 排行榜统计范围与顶部时间选择器保持一致
- 切换时间范围后，排行榜数据会自动重新加载

---

## ⚠️ 注意事项

1. **数据量大时加载较慢**
   - 违规数据：调用外部8543服务器
   - 频次数据：需要查询所有进出场记录
   - 建议：选择"今日"或"本周"获得更快响应

2. **异常检测规则**
   - 当前为简单规则：进出差异>5或总次数>50
   - 可根据实际情况调整阈值

3. **详情功能**
   - 违规详情：已实现，会自动筛选车牌号
   - 频次详情、通道详情：预留接口，待后续实现

4. **跨域配置**
   - 确保违规API（8543端口）已配置CORS
   - vue.config.js中已配置violation-api代理

---

## 🚀 扩展建议

### 短期优化
1. **缓存机制**：添加排行榜数据缓存，避免重复请求
2. **导出功能**：支持导出排行榜数据为Excel/CSV
3. **图表展示**：增加柱状图/饼图可视化展示

### 长期增强
1. **实时更新**：使用WebSocket实现排行榜实时刷新
2. **多维分析**：
   - 违规类型分布
   - 时段分布分析
   - 车辆类型对比
3. **智能告警**：
   - 异常车辆自动提醒
   - 高频通道容量预警
   - 违规趋势预测

---

## 更新日志

### 2025-11-28
- 实现违规排行榜功能
- 实现进出频次排行榜功能（车辆维度/通道维度）
- 添加数据分析下拉菜单入口
- 添加违规KPI卡片快捷链接
- 完成UI设计和动画效果
- 实现异常车辆检测和标记
- **新增业主信息显示**：
  - 违规排行榜显示车主姓名、手机号、VIP类型
  - 进出频次排行榜（车辆维度）显示业主信息
  - 业主信息采用多行布局，颜色区分不同信息类型
  - 无业主信息时显示"未知业主"标识

---

## 功能演示

访问智慧停车大屏页面，即可体验排行榜功能：
1. 点击右上角"数据分析"查看菜单
2. 鼠标悬停在"违规"卡片查看快捷入口
3. 选择不同时间范围观察数据变化
4. 切换排序方式和显示数量
5. 点击详情按钮深入查看

现在您可以更直观地发现：
- 🏆 哪些车辆违规最多
- 🔄 哪些车辆进出最频繁
- 🚪 哪些通道流量最大
- ⚠️ 哪些车辆存在异常
