# 数据可视化图表组件开发文档

## 概述

本文档基于 [DataV](http://datav.jiaminghi.com/guide/)、[Charts](http://charts.jiaminghi.com/example/) 和 [Apache ECharts](https://echarts.apache.org/examples/zh/index.html#chart-type-line) 的图表示例，结合智慧停车场数据可视化平台的实际项目，整理了一套完整的数据可视化图表组件开发指南。

## 技术栈

- **前端框架**: Vue 2.7.16
- **图表库**: ECharts 4.9.0
- **UI组件库**: @jiaminghi/data-view 2.10.0
- **样式预处理**: SCSS
- **构建工具**: Vue CLI 4.5.19

## 1. 项目架构

### 1.1 目录结构
```
src/
├── components/
│   └── echart/           # 图表组件目录
│       ├── bottom/       # 底部图表组件
│       ├── center/       # 中央图表组件
│       └── centreRight2/ # 右侧图表组件
├── views/                # 页面视图
├── services/             # 数据服务
├── assets/               # 静态资源
└── utils/                # 工具函数
```

### 1.2 组件设计原则

1. **单一职责**: 每个图表组件只负责一种图表类型的渲染
2. **数据驱动**: 通过 props 接收数据，支持响应式更新
3. **样式隔离**: 使用 scoped 样式避免样式冲突
4. **生命周期管理**: 正确处理组件的挂载和销毁

## 2. 核心图表组件

### 2.1 柱状图组件 (centreRight2Chart1.vue)

**功能**: 收费分析柱状图，展示不同停车时长的平均收费和车辆数量

**特点**:
- 双Y轴设计（收费金额 + 车辆数量）
- 柱状图 + 折线图组合
- 渐变色填充效果
- 响应式布局

**核心代码**:
```javascript
// 图表配置
let option = {
  tooltip: {
    trigger: "axis",
    backgroundColor: "rgba(255,255,255,0.1)",
    formatter: function(params) {
      // 自定义提示框内容
    }
  },
  legend: {
    data: ["平均收费", "车辆数量"],
    textStyle: { color: "#B4B4B4" }
  },
  xAxis: {
    type: "category",
    data: categories,
    axisLabel: {
      color: "#B4B4B4",
      fontSize: 8,
      rotate: 45
    }
  },
  yAxis: [
    {
      type: "value",
      name: "收费(元)",
      axisLabel: { formatter: "¥{value}" }
    },
    {
      type: "value", 
      name: "车辆数",
      axisLabel: { formatter: "{value}辆" }
    }
  ],
  series: [
    {
      name: "平均收费",
      type: "bar",
      yAxisIndex: 0,
      itemStyle: {
        normal: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: "#3b82f6" },
            { offset: 1, color: "#60a5fa" }
          ])
        }
      }
    },
    {
      name: "车辆数量",
      type: "line",
      yAxisIndex: 1,
      smooth: true,
      itemStyle: { normal: { color: "#10b981" } }
    }
  ]
};
```

### 2.2 流量对比图组件 (bottomLeftChart.vue)

**功能**: 进出场流量对比分析，展示24小时内的车辆进出情况

**特点**:
- 多系列柱状图对比
- 净流量折线图叠加
- 面积填充效果
- 实时数据更新

**核心代码**:
```javascript
series: [
  {
    name: "进场车辆",
    type: "bar",
    itemStyle: {
      normal: {
        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
          { offset: 0, color: "#10b981" },
          { offset: 1, color: "#34d399" }
        ])
      }
    }
  },
  {
    name: "离场车辆", 
    type: "bar",
    itemStyle: {
      normal: {
        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
          { offset: 0, color: "#f59e0b" },
          { offset: 1, color: "#fbbf24" }
        ])
      }
    }
  },
  {
    name: "净流量",
    type: "line",
    yAxisIndex: 1,
    areaStyle: {
      normal: {
        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
          { offset: 0, color: "rgba(59,130,246,0.3)" },
          { offset: 1, color: "rgba(59,130,246,0.05)" }
        ])
      }
    }
  }
]
```

### 2.3 极坐标柱状图组件 (centreLeft2Chart.vue)

**功能**: 车辆流动轨迹分析，使用极坐标展示不同区域的数据

**特点**:
- 极坐标系统
- 径向柱状图
- 彩虹色渐变
- 动态数据展示

**核心代码**:
```javascript
let option = {
  angleAxis: {
    type: "category",
    data: ["区域1", "区域2", "区域3", ...],
    axisLine: {
      lineStyle: { color: "#00c7ff", width: 1 }
    }
  },
  radiusAxis: {
    min: 0,
    max: 100,
    axisLabel: { formatter: "{value} %" }
  },
  series: [{
    name: "A",
    type: "bar",
    radius: ["20%", "100%"],
    data: [
      { value: 87, itemStyle: { normal: { color: "#f54d4d" } } },
      { value: 80, itemStyle: { normal: { color: "#f87544" } } },
      // ... 更多数据
    ],
    coordinateSystem: "polar"
  }]
};
```

## 3. DataV 边框组件集成

### 3.1 边框组件使用

项目中使用 DataV 提供的边框组件来美化图表容器：

```vue
<template>
  <dv-border-box-12>
    <centreRight2 :revenueData="revenueAnalysisData" />
  </dv-border-box-12>
</template>
```

### 3.2 常用边框组件

- `dv-border-box-1` ~ `dv-border-box-13`: 各种样式的边框容器
- `dv-loading`: 加载动画组件
- `dv-full-screen-container`: 全屏容器组件

## 4. 图表样式规范

### 4.1 颜色规范

```scss
// 主色调
$primary-color: #3b82f6;      // 蓝色
$success-color: #10b981;      // 绿色  
$warning-color: #f59e0b;      // 橙色
$danger-color: #f54d4d;       // 红色

// 文字颜色
$text-primary: #ffffff;       // 主文字
$text-secondary: #B4B4B4;     // 次要文字
$text-muted: #64748b;         // 辅助文字

// 背景色
$bg-primary: rgba(11, 19, 42, 0.9);    // 主背景
$bg-secondary: rgba(11, 19, 42, 0.6);  // 次背景
$bg-border: #1e3a8a;                   // 边框色
```

### 4.2 渐变色配置

```javascript
// 蓝色渐变
const blueGradient = new echarts.graphic.LinearGradient(0, 0, 0, 1, [
  { offset: 0, color: "#3b82f6" },
  { offset: 1, color: "#60a5fa" }
]);

// 绿色渐变  
const greenGradient = new echarts.graphic.LinearGradient(0, 0, 0, 1, [
  { offset: 0, color: "#10b981" },
  { offset: 1, color: "#34d399" }
]);

// 橙色渐变
const orangeGradient = new echarts.graphic.LinearGradient(0, 0, 0, 1, [
  { offset: 0, color: "#f59e0b" },
  { offset: 1, color: "#fbbf24" }
]);
```

## 5. 响应式设计

### 5.1 图表自适应

```javascript
// 监听窗口大小变化
window.addEventListener("resize", () => {
  if (myChart) {
    myChart.resize();
  }
}, false);

// 组件销毁时清理事件监听
destroyed() {
  window.onresize = null;
}
```

### 5.2 移动端适配

```scss
@media (max-width: 1200px) {
  .main-content-grid {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto;
  }
}

@media (max-width: 768px) {
  .chart-container {
    height: 300px;
    font-size: 12px;
  }
}
```

## 6. 数据更新机制

### 6.1 响应式数据更新

```javascript
watch: {
  chartData: {
    handler() {
      this.drawChart();
    },
    deep: true
  }
}
```

### 6.2 定时刷新

```javascript
// 启动数据刷新定时器
startDataRefresh() {
  this.dataTimer = setInterval(async () => {
    await this.loadAllData();
  }, 30000); // 30秒刷新一次
}
```

## 7. 性能优化

### 7.1 图表实例管理

```javascript
// 确保图表实例正确销毁
beforeDestroy() {
  if (this.myChart) {
    this.myChart.dispose();
    this.myChart = null;
  }
}
```

### 7.2 数据更新优化

```javascript
// 避免频繁更新，使用防抖
const debounceUpdate = debounce(() => {
  this.drawChart();
}, 300);
```

## 8. 常见问题解决

### 8.1 图表不显示

**问题**: 图表容器未正确渲染
**解决**: 确保在 `mounted` 生命周期中初始化图表

```javascript
mounted() {
  this.$nextTick(() => {
    this.drawChart();
  });
}
```

### 8.2 数据更新不生效

**问题**: 数据更新后图表未重新渲染
**解决**: 使用深度监听或强制更新

```javascript
// 方法1: 深度监听
watch: {
  chartData: {
    handler() { this.drawChart(); },
    deep: true
  }
}

// 方法2: 强制更新
this.chartData = { ...this.chartData };
```

### 8.3 内存泄漏

**问题**: 页面切换后图表实例未正确清理
**解决**: 在组件销毁时清理所有资源

```javascript
destroyed() {
  if (this.myChart) {
    this.myChart.dispose();
  }
  window.onresize = null;
  if (this.dataTimer) {
    clearInterval(this.dataTimer);
  }
}
```

## 9. 最佳实践

### 9.1 组件设计

1. **单一职责**: 每个组件只负责一种图表类型
2. **Props 验证**: 使用 TypeScript 或 PropTypes 验证数据格式
3. **错误处理**: 添加数据异常和渲染错误的处理逻辑
4. **文档注释**: 为每个组件添加详细的 JSDoc 注释

### 9.2 代码规范

1. **命名规范**: 使用语义化的变量和函数名
2. **代码复用**: 提取公共配置和工具函数
3. **样式管理**: 使用 SCSS 变量和混入提高可维护性
4. **性能监控**: 添加图表渲染性能监控

### 9.3 用户体验

1. **加载状态**: 数据加载时显示 loading 动画
2. **空数据处理**: 数据为空时显示友好提示
3. **交互反馈**: 添加 hover 和点击交互效果
4. **无障碍访问**: 考虑键盘导航和屏幕阅读器支持

## 10. 扩展功能

### 10.1 图表联动

```javascript
// 图表点击事件
myChart.on('click', (params) => {
  this.$emit('chart-click', params);
});

// 图表联动更新
updateLinkedCharts(selectedData) {
  this.$parent.updateAllCharts(selectedData);
}
```

### 10.2 数据导出

```javascript
// 导出图表为图片
exportChart() {
  const url = this.myChart.getDataURL({
    type: 'png',
    pixelRatio: 2,
    backgroundColor: '#fff'
  });
  this.downloadImage(url, 'chart.png');
}
```

### 10.3 主题切换

```javascript
// 动态切换主题
switchTheme(theme) {
  this.chartTheme = theme;
  this.drawChart();
}

// 主题配置
const themes = {
  dark: {
    backgroundColor: '#1a1a1a',
    textStyle: { color: '#fff' }
  },
  light: {
    backgroundColor: '#fff',
    textStyle: { color: '#333' }
  }
};
```

## 11. 总结

本文档基于 DataV、Charts 和 ECharts 的最佳实践，结合智慧停车场项目的实际需求，提供了一套完整的数据可视化图表组件开发指南。通过遵循这些规范和最佳实践，可以构建出高性能、可维护、用户体验良好的数据可视化应用。

## 参考资源

- [DataV 官方文档](http://datav.jiaminghi.com/guide/)
- [Charts 官方文档](http://charts.jiaminghi.com/example/)
- [Apache ECharts 官方文档](https://echarts.apache.org/examples/zh/index.html#chart-type-line)
- [Vue.js 官方文档](https://vuejs.org/)
- [SCSS 官方文档](https://sass-lang.com/)

---

*文档版本: v1.0*  
*最后更新: 2024年12月*
