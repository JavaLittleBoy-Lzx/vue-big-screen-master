# 多条进出场记录显示优化说明

## 修改目的

1. **显示所有进出场记录**：不只显示第一条记录，而是显示所有的进场和离场时间
2. **时间格式添加秒**：从 `MM-dd HH:mm` 改为 `MM-dd HH:mm:ss`，提供更精确的时间信息

## 业务场景

### 实际数据示例
```json
[
  {"enterTime":"2025-11-26 08:23:52","leaveTime":"2025-11-26 08:23:52"},
  {"enterTime":"2025-11-26 08:25:20"}
]
```

这种情况下：
- 第1次：08:23:52 进场，08:23:52 离场（可能是误识别或快速进出）
- 第2次：08:25:20 进场，尚未离场

**需求**：用户需要看到所有这些进出记录，了解完整的进出场历史。

## 修改内容

### 文件
`d:/nefu-edu-datav/vue-big-screen-master/src/views/VisitorPlanDashboard.vue`

### 1. 时间格式添加秒（第580-589行）

#### 修改前
```javascript
formatTime(time) {
  if (!time) return '-';
  const date = new Date(time);
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hour = String(date.getHours()).padStart(2, '0');
  const minute = String(date.getMinutes()).padStart(2, '0');
  return `${month}-${day} ${hour}:${minute}`;  // ❌ 没有秒
}
```

#### 修改后
```javascript
formatTime(time) {
  if (!time) return '-';
  const date = new Date(time);
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hour = String(date.getHours()).padStart(2, '0');
  const minute = String(date.getMinutes()).padStart(2, '0');
  const second = String(date.getSeconds()).padStart(2, '0');  // ✅ 添加秒
  return `${month}-${day} ${hour}:${minute}:${second}`;  // ✅ 包含秒
}
```

**效果对比**：
- 修改前：`11-26 08:23`
- 修改后：`11-26 08:23:52`

### 2. 显示所有进场记录（第599-621行）

#### 修改前（只显示第一条）
```javascript
getEntryTime(item) {
  const timesJson = this.modalType === 'vehicle' ? item.carVisitTimes : item.personVisitTimes;
  if (!timesJson) return '-';
  
  try {
    const times = JSON.parse(timesJson);
    // ❌ 只取第一个元素
    if (Array.isArray(times) && times.length > 0 && times[0].enterTime) {
      return this.formatTime(times[0].enterTime);
    }
  } catch (e) {
    console.error('解析进场时间失败:', e, timesJson);
  }
  return '-';
}
```

#### 修改后（显示所有记录）
```javascript
getEntryTime(item) {
  const timesJson = this.modalType === 'vehicle' ? item.carVisitTimes : item.personVisitTimes;
  if (!timesJson) return '-';
  
  try {
    const times = JSON.parse(timesJson);
    if (Array.isArray(times) && times.length > 0) {
      // ✅ 收集所有进场时间
      const enterTimes = times
        .filter(record => record.enterTime)  // 过滤出有进场时间的记录
        .map(record => this.formatTime(record.enterTime));  // 格式化
      
      if (enterTimes.length > 0) {
        // ✅ 多条记录用换行分隔
        return enterTimes.join('\n');
      }
    }
  } catch (e) {
    console.error('解析进场时间失败:', e, timesJson);
  }
  return '-';
}
```

**处理逻辑**：
1. 解析JSON数组
2. 过滤出所有有 `enterTime` 的记录
3. 格式化每个时间
4. 用换行符 `\n` 连接所有时间

### 3. 显示所有离场记录（第623-648行）

#### 修改后
```javascript
getExitTime(item) {
  const timesJson = this.modalType === 'vehicle' ? item.carVisitTimes : item.personVisitTimes;
  if (!timesJson) return '-';
  
  try {
    const times = JSON.parse(timesJson);
    if (Array.isArray(times) && times.length > 0) {
      // ✅ 收集所有离场时间
      const leaveTimes = times.map(record => {
        if (record.leaveTime) {
          return this.formatTime(record.leaveTime);
        }
        return '-';  // ✅ 未离场显示 -
      });
      
      if (leaveTimes.length > 0) {
        // ✅ 多条记录用换行分隔
        return leaveTimes.join('\n');
      }
    }
  } catch (e) {
    console.error('解析离场时间失败:', e, timesJson);
  }
  return '-';
}
```

**特殊处理**：
- 如果某条记录有进场但没有离场，离场时间显示 `-`
- 这样可以看出哪次进场还没有对应的离场

### 4. CSS支持多行显示（第981-987行）

#### 添加样式
```scss
td {
  padding: 14px 12px;
  color: #c3cbde;
  font-size: 13px;
  border-bottom: 1px solid rgba(0, 229, 255, 0.1);
  white-space: pre-line; // ✅ 支持多行显示（保留换行符）
  vertical-align: top; // ✅ 顶部对齐，多行时更美观
  
  // ... 其他样式
}
```

**CSS属性说明**：
- `white-space: pre-line`：保留换行符，使 `\n` 能正常显示为换行
- `vertical-align: top`：单元格内容顶部对齐，避免多行文本居中显示不美观

## 显示效果

### 示例数据
```json
[
  {"enterTime":"2025-11-26 08:23:52","leaveTime":"2025-11-26 08:23:52"},
  {"enterTime":"2025-11-26 08:25:20"},
  {"enterTime":"2025-11-26 10:30:15","leaveTime":"2025-11-26 12:45:30"}
]
```

### 表格显示效果

| 序号 | 访客姓名 | 进场时间 | 离场时间 | 来访状态 |
|------|----------|----------|----------|----------|
| 1    | 张三     | 11-26 08:23:52<br>11-26 08:25:20<br>11-26 10:30:15 | 11-26 08:23:52<br>-<br>11-26 12:45:30 | 来访中 |

**说明**：
- 第1次：08:23:52 进场，08:23:52 离场（完整记录）
- 第2次：08:25:20 进场，尚未离场（显示 `-`）
- 第3次：10:30:15 进场，12:45:30 离场（完整记录）

## 时间格式对比

### 修改前
```
11-26 08:23
11-26 08:25
11-26 10:30
```

### 修改后
```
11-26 08:23:52
11-26 08:25:20
11-26 10:30:15
```

**优势**：
- ✅ 更精确：可以区分同一分钟内的多次进出
- ✅ 更专业：符合安防系统的精确度要求
- ✅ 更易追溯：便于核对具体的进出时间

## 测试步骤

### 1. 准备测试数据

插入多条进出场记录：
```sql
UPDATE visitor_reservation_sync 
SET person_visit_times = '[
  {"enterTime":"2025-11-26 08:23:52","leaveTime":"2025-11-26 08:23:52"},
  {"enterTime":"2025-11-26 08:25:20"},
  {"enterTime":"2025-11-26 10:30:15","leaveTime":"2025-11-26 12:45:30"}
]'
WHERE id = 1;

UPDATE visitor_reservation_sync 
SET car_visit_times = '[
  {"enterTime":"2025-11-26 08:00:00","leaveTime":"2025-11-26 09:00:00"},
  {"enterTime":"2025-11-26 14:30:25"}
]'
WHERE id = 6;
```

### 2. 测试访客详情

1. 刷新页面（前端热更新）
2. 点击"计划访客"水波图
3. 查看详情弹窗

**预期效果**：
- 进场时间列显示3行：
  ```
  11-26 08:23:52
  11-26 08:25:20
  11-26 10:30:15
  ```
- 离场时间列显示3行：
  ```
  11-26 08:23:52
  -
  11-26 12:45:30
  ```

### 3. 测试车辆详情

1. 点击"预计车辆"水波图
2. 查看详情弹窗

**预期效果**：
- 进场时间列显示2行：
  ```
  11-26 08:00:00
  11-26 14:30:25
  ```
- 离场时间列显示2行：
  ```
  11-26 09:00:00
  -
  ```

### 4. 验证单条记录

对于只有一条记录的数据：
```json
[{"enterTime":"2025-11-26 08:00:00","leaveTime":"2025-11-26 18:00:00"}]
```

**预期效果**：
- 进场时间：`11-26 08:00:00`（单行）
- 离场时间：`11-26 18:00:00`（单行）

## 边界情况处理

### 1. 空数据
```json
null 或 ""
```
**显示**：`-`

### 2. 空数组
```json
[]
```
**显示**：`-`

### 3. 只有进场没有离场
```json
[{"enterTime":"2025-11-26 08:00:00"}]
```
**显示**：
- 进场时间：`11-26 08:00:00`
- 离场时间：`-`

### 4. JSON格式错误
```json
"invalid json"
```
**处理**：
- 控制台输出错误日志
- 显示：`-`

### 5. 多次进出（频繁进出）
```json
[
  {"enterTime":"2025-11-26 08:00:00","leaveTime":"2025-11-26 09:00:00"},
  {"enterTime":"2025-11-26 10:00:00","leaveTime":"2025-11-26 11:00:00"},
  {"enterTime":"2025-11-26 14:00:00","leaveTime":"2025-11-26 15:00:00"},
  {"enterTime":"2025-11-26 16:00:00"}
]
```
**显示**：
- 进场时间：4行
- 离场时间：4行（最后一行显示 `-`）

## 性能考虑

### 当前实现
- 每次渲染都会解析JSON并格式化时间
- 对于少量记录（< 10条）性能影响很小

### 优化建议（如果数据量大）

如果单个访客有非常多的进出记录（> 20条），可以考虑：

1. **限制显示数量**
   ```javascript
   const enterTimes = times
     .filter(record => record.enterTime)
     .slice(0, 10)  // 只显示前10条
     .map(record => this.formatTime(record.enterTime));
   
   if (times.length > 10) {
     enterTimes.push('...');  // 超过10条显示省略号
   }
   ```

2. **使用计算属性缓存**
   ```javascript
   computed: {
     parsedDetailList() {
       return this.detailList.map(item => ({
         ...item,
         entryTimes: this.getEntryTime(item),
         exitTimes: this.getExitTime(item)
       }));
     }
   }
   ```

3. **分页显示**
   - 在弹窗中添加二级分页
   - 每页显示5条进出记录

## 用户体验优化

### 1. 行高自动调整
CSS中使用 `white-space: pre-line` 和 `vertical-align: top`，行高会自动适应内容。

### 2. 滚动条优化
如果记录太多导致表格很长，表格容器有滚动条：
```scss
.table-wrapper {
  max-height: calc(85vh - 200px);
  overflow-y: auto;
}
```

### 3. 对齐优化
使用 `vertical-align: top` 确保多行内容顶部对齐，避免视觉混乱。

### 4. 间距优化
多行文本的行间距由浏览器默认 `line-height` 控制，如需调整：
```scss
td {
  line-height: 1.6;  // 调整行间距
}
```

## 相关文件

- **前端组件**: `/src/views/VisitorPlanDashboard.vue`
- **后端工具类**: `/src/main/java/com/parkingmanage/util/VisitTimeUtils.java`

## 修改完成时间

2025-11-26 10:54

## 总结

✅ 时间格式添加秒显示（`MM-dd HH:mm:ss`）  
✅ 显示所有进出场记录，而不是只显示第一条  
✅ 多条记录换行显示，清晰直观  
✅ 未离场的记录显示 `-`，便于识别  
✅ CSS支持多行文本和顶部对齐  
✅ 完善的边界情况处理

这样用户可以看到完整的进出场历史，了解所有的访问记录，便于核对和追溯。
