# 字段映射修正说明

## 更新时间
2025-11-25 19:10

## 问题描述
预约信息列全部显示"-"，原因是代码中使用了数据库中不存在的字段。

## 根本原因
后端代码尝试使用不存在的字段：
- ❌ `reservation_form_name`（数据库中没有此字段）
- ❌ `reservation_car_plate`（数据库中没有此字段）

## 数据库实际字段映射

| 业务含义 | 数据库字段名 | 实体类字段名 | 说明 |
|---------|------------|------------|------|
| 预约时间段 | `reservation_time_range` | `reservationTimeRange` | 已存在 ✅ |
| 表单名称 | `vip_type_name` | `vipTypeName` | 已存在 ✅ |
| 车牌号码 | `plate_number` | `plateNumber` | 已存在 ✅ |

## 修复内容

### 1. 后端 `FaceMonitorController.java`

**修改前**：
```java
// 预约相关信息
data.put("reservationTimeRange", record.getReservationTimeRange());
data.put("reservationFormName", record.getReservationFormName());  // ❌ 字段不存在
data.put("reservationCarPlate", record.getReservationCarPlate());  // ❌ 字段不存在
```

**修改后**：
```java
// 预约相关信息
data.put("reservationTimeRange", record.getReservationTimeRange());
data.put("reservationFormName", record.getVipTypeName());  // ✅ 使用vip_type_name
data.put("reservationCarPlate", record.getPlateNumber());  // ✅ 使用plate_number
```

### 2. 实体类 `AcmsEventRecord.java`

**删除了不存在的字段**：
```java
// ❌ 删除这两个字段（数据库中不存在）
@ApiModelProperty(value = "预约表单名称（访客预约的申请表单名称）")
private String reservationFormName;

@ApiModelProperty(value = "预约携带车牌号（访客预约时填写的车牌号）")
private String reservationCarPlate;
```

**使用已有字段**：
```java
// ✅ 使用这两个已存在的字段
@ApiModelProperty(value = "车牌号码（只有访客会有）")
private String plateNumber;

@ApiModelProperty(value = "VIP类型名称（从访客预约记录中获取）")
private String vipTypeName;
```

### 3. 前端 `center.vue`

前端不需要修改，继续使用 `reservationFormName` 和 `reservationCarPlate` 作为显示字段名，后端会正确映射。

## 数据示例

### 数据库查询
```sql
SELECT 
    person_name,
    reservation_time_range,
    vip_type_name,          -- 表单名称
    plate_number            -- 车牌号码
FROM acms_event_record
WHERE reservation_time_range IS NOT NULL
LIMIT 1;
```

### 后端返回
```json
{
  "personName": "张三",
  "reservationTimeRange": "2025-11-25 14:00:00-2025-11-25 16:00:00",
  "reservationFormName": "访客预约申请",    // 来自vip_type_name
  "reservationCarPlate": "京A12345",        // 来自plate_number
  "isReservedVisitor": true,
  "isPureVisitor": false
}
```

### 前端显示
```
预约信息列：时间：2025-11-25 14:00:00-2025-11-25 16:00:00 | 表单：访客预约申请 | 车牌：京A12345
```

## 测试步骤

### 1. 重启后端服务 ⚠️
```bash
# 修改了Java代码，必须重启Spring Boot应用
```

### 2. 插入测试数据
```sql
-- 找一条人证比对记录
UPDATE acms_event_record
SET 
    reservation_time_range = '2025-11-25 14:00:00-2025-11-25 16:00:00',
    vip_type_name = '访客预约申请',
    plate_number = '京A12345'
WHERE id = (
    SELECT id FROM acms_event_record 
    WHERE event_type = 197162
    ORDER BY event_time DESC 
    LIMIT 1
);
```

### 3. 刷新前端页面
- 使用 `Ctrl + Shift + R` 强制刷新
- 打开人脸进场/出场详情
- 查看预约信息列

### 4. 验证结果
**预期效果**：
- 有预约信息的记录显示：`时间：xxx | 表单：xxx | 车牌：xxx`（绿色样式）
- 纯访客显示：`纯访客（未预约）`（橙色样式）
- 其他人员显示：`-`（灰色）

## 注意事项

1. **数据库字段已存在**：`vip_type_name` 和 `plate_number` 是数据库中已有的字段
2. **不需要添加新字段**：直接使用现有字段即可
3. **前端无需修改**：后端负责字段映射，前端继续使用 `reservationFormName` 和 `reservationCarPlate`
4. **向后兼容**：这次修改是字段映射修正，不影响其他功能

## 相关文件

- ✅ `FaceMonitorController.java` - 修改字段映射
- ✅ `AcmsEventRecord.java` - 删除不存在的字段
- ✅ `预约信息排查指南.md` - 更新SQL示例
- ⚠️ 需要重启后端服务

## 完成状态

- [x] 后端字段映射修正
- [x] 实体类字段清理
- [x] 文档更新
- [ ] 后端服务重启（需用户执行）
- [ ] 测试验证（需用户执行）
